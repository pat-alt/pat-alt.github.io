---
title: Endogenous Macrodynamics in Algorithmic Recourse
subtitle: IEEE --- Secure and Trustworthy Machine Learning
author: 
  - name: "**Patrick Altmeyer**"
    url: https://www.paltmeyer.com/
  - name: Giovan Angela
  - name: Aleksander 
  - name: Karol
  - name: Arie van Deursen
  - name: Cynthia C. S. Liem
institute: Delft University of Technology
date: today
format: 
  tudelft-revealjs:
    theme: custom.scss
    footer: IEEE Secure and Trustworthy Machine Learning '23 --- Patrick Altmeyer --- CC BY-NC
    self-contained: true
    smaller: true
    scrollable: true
    preview-links: auto
    slide-number: true
    transition: slide
    background-transition: fade
    fig-align: center
---

## Quick Intro

::::{.columns}

:::{.column width="60%"}

- Currently 2nd year of PhD in Trustworthy Artificial Intelligence at Delft University of Technology.
- Working on Counterfactual Explanations and Probabilistic Machine Learning with applications in Finance.
- Previously, educational background in Economics and Finance and two years at the Bank of England.
- Enthusiastic about free open-source software, in particular Julia and Quarto. 

:::

:::{.column width="40%"}

<img src="/www/images/profile.jpg" height="auto" width="250" style="border-radius:50%; display: block; margin-left: auto; margin-right: auto;">

<div style="text-align: center;">
  <p style="display: inline; vertical-align: middle"> 
    <a href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/d0fc399dee4218d1e0e0399b8947acab.png" alt="LinkedIn (Personal)" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://twitter.com/paltmey" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/3949237f892004c237021ac9e3182b1d.png" alt="Twitter" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://github.com/pat-alt" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/47f4eb2d0082a8a3611d614b75a09db8.png" alt="Github" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://medium.com/@patrick.altmeyer" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/175f49662614345cb7dbb95fce3f88af.png" alt="Medium" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
  </p>
</div>

<img src="/www/images/qr.png" height="auto" width="100" style="display: block; margin-left: auto; margin-right: auto;">
:::

::::

# Motivation and Contributions

## In a nutshell ... 

> [...] we run experiments that simulate the application of recourse in practice using various state-of-the-art counterfactual generators and find that all of them induce substantial domain and model shifts.

- **Counterfactual Explanation** (CE) explain how inputs into a model need to change for it to produce different outputs.
- Counterfactual Explanations that involve realistic and actionable changes can be used for the purpose of **Algorithmic Recourse** (AR) to help individuals who face adverse outcomes.

![Dynamics in Algorithmic Recourse: (a) we have a simple linear classifier trained for binary classification where samples from the negative class ($y=0$) are marked in blue and samples of the positive class ($y=1$) are marked in orange; (b) the implementation of AR for a random subset of individuals leads to a noticable domain shift; (c) as the classifier is retrained we observe a corresponding model shift; (d) as this process is repeated, the decision boundary moves away from the target class.](/www/images/ieee_poc.png){#fig-poc}

:::{.callout-tip}

## ðŸ”‘ Key Contributions

- We find that the induced shifts are substantial enough to likely impede the applicability of Algorithmic Recourse in some situations.
- Fortunately, we find various strategies to mitigate these concerns. 
- Our simulation framework for studying recourse dynamics is fast and open-sourced. 

:::

## Consumer Credit Example

::: {.incremental}
- Suppose @fig-poc relates to an automated decision-making system used by a retail bank to evaluate credit applicants with respect to their creditworthiness. 
- Assume that the two features are meaningful in the sense that creditworthiness increases in the south-east direction. 
- Then we can think of the outcome in panel (d) as representing a situation where the bank supplies credit to more borrowers (orange), but these borrowers are on average less creditworthy and more of them can be expected to default on their loan. 
- This represents a cost to the retail bank.
:::

## Student Admission Example

::: {.incremental}
- Suppose Figure @fig-poc relates to an automated decision-making system used by a university in its student admission process. 
- Assume that the two features are meaningful in the sense that the likelihood of students completing their degree increases in the south-east direction. 
- Then we can think of the outcome in panel (b) as representing a situation where more students are admitted to university (orange), but they are more likely to fail their degree than students that were admitted in previous years. 
- The university admission committee catches on to this and suspends its efforts to offer Algorithmic Recourse. 
- This represents an opportunity cost to future student applicants, that may have derived utility from being offered recourse.
:::

# Background

## Algorithmic Recourse

> Even though [...] interpretability is of great importance and should be pursued, explanations can, in principle, be offered without opening the â€œblack boxâ€.
> [@wachter2017counterfactual]

::::{.columns}

:::{.column width="50%"}

#### Framework

. . .

Objective originally proposed by @wachter2017counterfactual is as follows

$$
\min_{x^\prime \in \mathcal{X}} \text{cost}(x^\prime) \ \ \ \mbox{s. t.} \ \ \ M(x^\prime) = y^* 
$$ {#eq-obj}

Typically this is approximated through regularization:

$$
x^\prime = \arg \min_{x^\prime}  \text{yloss}(M(x^\prime),y^*) + \lambda \text{cost}(x^\prime) 
$$ {#eq-solution}

:::

:::{.column width="50%"}

#### Intuition

. . .

![A cat performing gradient descent in the feature space Ã  la @wachter2017counterfactual.](https://raw.githubusercontent.com/pat-alt/CounterfactualExplanations.jl/main/docs/src/www/recourse_mlp.gif){#fig-cat-mlp}

:::

# Gradient-Based Recourse Revisited {#method}

## From individual recourse ... {#method-general}

- We include the following generators in our simulation experiments below: **REVISE** [@joshi2019realistic], **CLUE** [@antoran2020getting], **DiCE** [@mothilal2020explaining] and a greedy approach that relies on probabilistic models [@schut2021generating].
- All of them can be described by the following generalized form of Equation \@ref(eq:general):

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \left\{  {\text{yloss}(M(f(\mathbf{s}^\prime)),y^*)}+ \lambda {\text{cost}(f(\mathbf{s}^\prime)) }  \right\} 
\end{aligned} 
$$ {#eq-general}

- Here $\mathbf{s}^\prime=\left\{s_k^\prime\right\}_K$ is a $K$-dimensional array of counterfactual states and $f: \mathcal{S} \mapsto \mathcal{X}$ maps from the counterfactual state space to the feature space.

## ... towards collective recourse {#method-collective}

- All of the different approaches introduced above tackle the problem of Algorithmic Recourse from the perspective of one single individual.
- We propose to extend Equation @eq-general as follows:

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \{ {\text{yloss}(M(f(\mathbf{s}^\prime)),y^*)} \\ &+ \lambda_1 {\text{cost}(f(\mathbf{s}^\prime))} + \lambda_2 {\text{extcost}(f(\mathbf{s}^\prime))} \}  
\end{aligned} 
$$ {#eq-collective}

- Here $\text{cost}(f(\mathbf{s}^\prime))$ denotes the proxy for private costs faced by the individual as before and $\lambda_1$ governs to what extent that private cost ought to be penalized. 
- The newly introduced term $\text{extcost}(f(\mathbf{s}^\prime))$ is meant to capture and address external costs incurred by the collective of individuals in response to changes in $\mathbf{s}^\prime$.
- The underlying concept of private and external costs is borrowed from Economics and well-established in that field: when the decisions or actions by some individual market participant generate external costs, then the market is said to suffer from negative externalities and is considered inefficient [@pindyck2014microeconomics].

# Modeling Endogenous Macrodynamics in Algorithmic Recourse {#method-2}

## Research Questions

::: {.proposition #shifts name="Endogenous Shifts"}
Does the repeated implementation of recourse provided by state-of-the-art generators lead to shifts in the domain and model?
:::

::: {.proposition #costs name="Costs"}
If so, are these dynamics substantial enough to be considered costly to stakeholders involved in real-world automated decision-making processes?
:::

::: {.proposition #het name="Heterogeneity"}
Do different counterfactual generators yield significantly different outcomes in this context? Furthermore, is there any heterogeneity concerning the chosen classifier and dataset?
:::

::: {.proposition #drive name="Drivers"}
What are the drivers of endogenous dynamics in Algorithmic Recourse?
:::

## Simulations {#method-2-experiment}

\begin{algorithm}
\caption{Simulation Experiment}\label{algo-experiment}
\begin{algorithmic}[1]
\Procedure{Experiment}{$M,\mathcal{D},G$}
\State $E\gets \emptyset$ \Comment{Initialize evaluation $E$.}
\State $t\gets 0$
\While{$t<T$}
\State $\text{batch} \subset \mathcal{D}_0$ \Comment{Sample from $\mathcal{D}_0$  (assignment).}
\State $\text{batch}\gets G(\text{batch})$ \Comment{Generate counterfactuals.}
\State $M\gets M(\mathcal{D})$ \Comment{Retrain model.}
\State $E\gets \text{eval}(M,\mathcal{D}) \cup E$ \Comment{Update evaluation.}
\State $t\gets t+1$ \Comment{Increment $t$.}
\EndWhile
\State \textbf{return} $E, M,\mathcal{D}$
\EndProcedure
\end{algorithmic}
\end{algorithm}

## Evaluation Metrics {#method-2-metrics}

# Experiment Setup {#empirical}

## $M$---Classifiers and Generative Models {#empirical-classifiers}

```{r architecture}
tab <- data.frame(
  "Model" = c("MLP","MLP","VAE","VAE"),
  "Data" = c("Synthetic", "Real-World", "Synthetic", "Real-World"),
  "Hidden" = c(32,64,32,32),
  "Latent" = c("-","-",2,8),
  "Layers" = c(1,2,1,1),
  "Batch" = c("-",500,"-","-"),
  "Dropout" = c("-",0.1,"-","-"),
  "Epochs" = c(100,100,100,250)
)
library(kableExtra)
kbl(
  tab, booktabs = TRUE,
  caption = 'Neural network architectures and training parameters.',
  col.names = c("Model","Data","Hidden Dim.","Latent Dim.","Hidden Layers", "Batch", "Dropout", "Epochs")
) |> 
  collapse_rows(1:2, row_group_label_position = 'stack') |>
  kable_styling(latex_options = c("scale_down"))
```

## $\mathcal{D}$---Data {#empirical-data}

### Synthetic Data

We use four synthetic binary classification datasets consisting of 1000 samples each: **Overlapping**, **Linearly Separable**, **Circles** and **Moons** @fig-synthetic-data.

![Synthetic classification datasets used in our experiments. Samples from the negative class ($y=0$) are marked in blue while samples of the positive class ($y=1$) are marked in orange.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/main/paper/www/synthetic_data.png){#fig-synthetic-data}

### Real-World Data

We use three different real-world datasets from the Finance and Economics domain, all of which are tabular and can be used for binary classification. 

1. The **Give Me Some Credit** dataset: predict whether a borrower is likely to experience financial difficulties in the next two years [@kaggle2011give].
2. The **UCI defaultCredit** dataset [@yeh2009comparisons]: a benchmark dataset that can be used to train binary classifiers to predict the whether credit card clients default on their payment.
3. The **California Housing** dataset [@pedregosa2011scikitlearn, @pace1997sparse]: continuous outcome variable binarized as $\tilde{y}=\mathbb{I}_{y>\text{median}(Y)}$ indicating if the median house price of a given district is above the median of all districts.

## $G$---Generators

- All generators introduced earlier are included in the experiments: Wachter [@wachter2017counterfactual], REVISE [@joshi2019realistic], CLUE [@antoran2020getting], DiCE [@mothilal2020explaining] and Greedy [@schut2021generating]. 
- In addition, we introduce two new generators in Section \@ref(mitigate) that directly address the issue of endogenous domain and model shifts. We also test to what extent it may be beneficial to combine ideas underlying the various generators. 

# Experiments {#empirical-2}

# Mitigation Strategies and Experiments {#mitigate}

# Discussion {#discussion}

# Limitations and Future Work {#limit}

# Concluding Remarks {#conclusion}

# Questions & Answers â“

# Final Things ðŸ

## More Resources ðŸ“š

::::{.columns}

:::{.column width="60%"}

> Read on ...

- Related blog posts (hosted on this website that itself is built with Quarto and involves lots of Julia content): [[1]((https://www.paltmeyer.com/blog/posts/julia-and-quarto-a-match-made-in-heaven/))] and [[2](https://www.paltmeyer.com/blog/posts/tips-and-tricks-for-using-quarto-with-julia/)]. 
- Blog post introducing CE: [[TDS](https://towardsdatascience.com/individual-recourse-for-black-box-models-5e9ed1e4b4cc)], [[blog](https://www.paltmeyer.com/blog/posts/individual-recourse-for-black-box-models/)].
- Blog post on Laplace Redux: [[TDS](https://towardsdatascience.com/go-deep-but-also-go-bayesian-ab25efa6f7b)], [[blog](https://www.paltmeyer.com/blog/posts/effortsless-bayesian-dl/)].
- Blog post on Conformal Prediction: [[TDS](https://towardsdatascience.com/conformal-prediction-in-julia-351b81309e30)], [[blog](https://www.paltmeyer.com/blog/posts/conformal-prediction/)].

> ... or get involved! ðŸ¤—

- [Contributor's Guide](https://www.paltmeyer.com/CounterfactualExplanations.jl/dev/contributing/) for `CounterfactualExplanations.jl`
- [Contributor's Guide](file:///Users/FA31DU/code/ConformalPrediction.jl/docs/build/contribute.html) for `ConformalPrediction.jl`

:::

:::{.column width="40%"}

<img src="/www/images/profile.jpg" height="auto" width="250" style="border-radius:50%; display: block; margin-left: auto; margin-right: auto;">

<div style="text-align: center;">
  <p style="display: inline; vertical-align: middle"> 
    <a href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/d0fc399dee4218d1e0e0399b8947acab.png" alt="LinkedIn (Personal)" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://twitter.com/paltmey" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/3949237f892004c237021ac9e3182b1d.png" alt="Twitter" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://github.com/pat-alt" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/47f4eb2d0082a8a3611d614b75a09db8.png" alt="Github" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://medium.com/@patrick.altmeyer" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/175f49662614345cb7dbb95fce3f88af.png" alt="Medium" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
  </p>
</div>

<img src="/www/images/qr.png" height="auto" width="100" style="display: block; margin-left: auto; margin-right: auto;">
:::

::::

## Image Sources

- Quarto logo. Source: [Quarto](https://raw.githubusercontent.com/quarto-dev/quarto-web/main/quarto.png)
- Julia to Quarto animation. Source: author (heavily borrowing from `Javis.jl` [tutorial](https://juliaanimators.github.io/Javis.jl/stable/tutorials/tutorial_7/))

## References 