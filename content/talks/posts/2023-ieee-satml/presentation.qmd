---
title: Endogenous Macrodynamics in Algorithmic Recourse
subtitle: IEEE Conference on Secure and Trustworthy Machine Learning
author: 
  - name: "**Patrick Altmeyer**"
    url: https://www.paltmeyer.com/
  - name: Giovan Angela
  - name: Aleksander Buszydlik
  - name: Karol Dobiczek
  - name: Arie van Deursen
  - name: Cynthia C. S. Liem
institute: Delft University of Technology
date: today
format: 
  tudelft-revealjs:
    theme: custom.scss
    footer: IEEE Conference on Secure and Trustworthy Machine Learning '23 --- Patrick Altmeyer --- CC BY-NC
    self-contained: true
    smaller: true
    scrollable: true
    preview-links: auto
    slide-number: true
    transition: slide
    background-transition: fade
    fig-align: center
crossref: 
  prp-title: RQ
  prp-prefix: RQ
---

## In a nutshell ... 

> [...] we run experiments that simulate the application of recourse in practice using various state-of-the-art counterfactual generators and find that all of them induce substantial domain and model shifts.

:::{.incremental}
- **Counterfactual Explanation** (CE) explain how inputs into a model need to change for it to produce different outputs.
- Counterfactual Explanations that involve realistic and actionable changes can be used for the purpose of **Algorithmic Recourse** (AR) to help individuals who face adverse outcomes.
:::

. . .

:::{.callout-note icon=false}

## 🎯 Key Contributions

- We adjust the methodological framework to explicitly account for external costs of recourse.
- We propose various strategies to mitigate these costs. 
- We have open-sourced our simulation framework: [`AlgorithmicRecourseDynamics.jl`](https://github.com/pat-alt/AlgorithmicRecourseDynamics.jl)

:::

## Proof-of-Concept 

::::{.columns}::::
:::{.column width='60%'}

Consider @fig-poc:

::: {.incremental}

a) Retail bank has trained binary classifier to evaluate credit applicants; credit risk highest in bottom-right corner.
b) Bank provides recourse to unsuccessful applicants. 
c) Bank retrains classifier.
d) **Outcome**: bank supplies credit to more borrowers (orange), but these borrowers are riskier on average, which represents a cost to the retail bank.

:::

:::
:::{.column width='40%'}
![Dynamics in Algorithmic Recourse.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/poc.png){#fig-poc}
:::
::::


# Gradient-Based Recourse Revisited {#method}

## Algorithmic Recourse

> Even though [...] interpretability is of great importance and should be pursued, explanations can, in principle, be offered without opening the “black box”.
> [@wachter2017counterfactual]

::::{.columns}

:::{.column width="50%"}

#### Framework

. . .

Objective function originally proposed by @wachter2017counterfactual is as follows

$$
\min_{x^\prime \in \mathcal{X}} \text{cost}(x^\prime) \ \ \ \mbox{s. t.} \ \ \ M(x^\prime) = y^* 
$$ {#eq-obj}

Typically this is approximated through regularization:

$$
x^\prime = \arg \min_{x^\prime}  \text{yloss}(M(x^\prime),y^*) + \lambda \text{cost}(x^\prime) 
$$ {#eq-solution}

:::

:::{.column width="50%"}

#### Intuition

. . .

![Counterfactuals for Give Me Some Credit dataset [@kaggle2011give].](www/gmsc.svg){#fig-credit}

:::

::::

## From individual recourse ... {#method-general}

. . .

- Included generators: **REVISE** [@joshi2019realistic], **CLUE** [@antoran2020getting], **DiCE** [@mothilal2020explaining] and a **Greedy** approach that relies on probabilistic models [@schut2021generating].

. . .

- All of them can be described by the following generalized form of @eq-solution:

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \left\{  {\text{yloss}(M(f(\mathbf{s}^\prime)),y^*)}+ \lambda {\text{cost}(f(\mathbf{s}^\prime)) }  \right\} 
\end{aligned} 
$$ {#eq-general}

. . .

![Feature space (left) and counterfactual state space (right).](/www/images/example_3d.png){#fig-state-space width="50%"}

## ... towards collective recourse {#method-collective}

- All of the different approaches introduced above tackle the problem of Algorithmic Recourse from the perspective of one **single individual**.

. . .

- We propose to extend @eq-general as follows:

$$
\begin{aligned}
\mathbf{s}^\prime &= \arg \min_{\mathbf{s}^\prime \in \mathcal{S}} \{ {\text{yloss}(M(f(\mathbf{s}^\prime)),y^*)} \\ &+ \lambda_1 {\text{cost}(f(\mathbf{s}^\prime))} + \lambda_2 {\text{extcost}(f(\mathbf{s}^\prime))} \}  
\end{aligned} 
$$ {#eq-collective}

. . .

- Here $\text{cost}(f(\mathbf{s}^\prime))$ denotes the proxy for **private costs** faced by the individual; the newly introduced term $\text{extcost}(f(\mathbf{s}^\prime))$ is meant to capture **external costs** generated by changes to $\mathbf{s}^\prime$.

. . .

- We borrow the concept of **Negative Externalities** from Economics (see more detailed [slide pack](https://www.paltmeyer.com/content/talks/posts/2023-ieee-satml/long_presentation.html))

# Modeling Endogenous Macrodynamics in Algorithmic Recourse {#method-2}

## Research Questions

#### Principal Concerns

::: {#prp-shifts}
## Endogenous Shifts

Does the repeated implementation of recourse provided by state-of-the-art generators lead to shifts in the domain and model?
:::

::: {#prp-costs}
## Costs

If so, are these dynamics substantial enough to be considered costly to stakeholders involved in real-world automated decision-making processes?
:::

::: {#prp-het}
## Heterogeneity

Do different counterfactual generators yield significantly different outcomes in this context? Furthermore, is there any heterogeneity concerning the chosen classifier and dataset?
:::

::: {#prp-drive}
## Drivers

What are the drivers of endogenous dynamics in Algorithmic Recourse?
:::

#### Secondary Concerns

::: {#prp-mitigate}
## Mitigation Strategies

What are potential mitigation strategies with respect to endogenous macrodynamics in AR?
:::

## Empirical Setup

. . .

- **Evaluation metrics**: propose various metrics to measure domain shifts (MMD) and model shifts (MMD, parameter perturbations, disagreement coefficient, ...)

. . . 

- **Models**: we use linear classifiers, deep neural networks and deep ensembles.

. . .

- **Data**: we look at synthetic and real-world datasets:
    - Four synthetic datasets: **Overlapping**, **Linearly Separable**, **Circles** and **Moons** (@fig-synthetic-data).
    - Three real-world datasets from the Finance and Economics domain: **Give Me Some Credit** [@kaggle2011give], **UCI defaultCredit** [@yeh2009comparisons] and **California Housing** [@pedregosa2011scikitlearn, @pace1997sparse].

![Synthetic classification datasets used in our experiments. Samples from the negative class ($y=0$) are marked in orange while samples of the positive class ($y=1$) are marked in blue.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/synthetic_data.png){#fig-synthetic-data}

. . .

- **Generators**: from the existing literature we use Wachter [@wachter2017counterfactual], REVISE [@joshi2019realistic], DiCE [@mothilal2020explaining], Greedy [@schut2021generating]

## Principal Findings

::::{.columns}

:::{.column width="50%"}

![Results for synthetic data.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/synthetic_results.png)
:::

:::{.column width="50%"}

![Results for real-world data.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/real_world_results.png)

:::

::::

## Mitigation Strategies

- More Conservative Decision Thresholds
- Classifier Preserving ROAR (ClaPROAR)^[Loosely inspired by ROAR [@upadhyay2021robust]]:

$$
\begin{aligned}
\text{extcost}(f(\mathbf{s}^\prime)) = l(M(f(\mathbf{s}^\prime)),y^\prime) 
\end{aligned}
$$ {#eq-clap}

- Gravitational Counterfactual Explanations:

$$
\begin{aligned}
\text{extcost}(f(\mathbf{s}^\prime)) = \text{dist}(f(\mathbf{s}^\prime),\bar{x}^*) 
\end{aligned}
$$ {#eq-grav}

![Mitigation strategies.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/mitigation.png)

## Secondary Findings

::::{.columns}

:::{.column width="50%"}

![Results for synthetic data.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/mitigation_synthetic_results.png)
:::

:::{.column width="50%"}

![Results for real-world data.](https://raw.githubusercontent.com/pat-alt/endogenous-macrodynamics-in-algorithmic-recourse/camera-ready-branch/paper/www/mitigation_real_world_results.png)

:::

::::

# Discussion

## Key Takeaways 🔑

. . .

- State-of-the-art approaches to AR induce substantial domain and model shifts.

. . .

- External costs of Individual Recourse should be shared across stakeholders.

. . .

- Straightforward way to achieve this is to explicitly penalize external costs in the counterfactual search objective function (@eq-collective).

. . .

#### Future Research Ideas

**Private vs. External Costs**: 

- How can we make informed choices about the tradeoff between private and external costs?
- Pareto-optimal collective recourse?

**Causal Modelling**: 

- How do things play out for recent approaches to AR that incorporate causal knowledge such as @karimi2021algorithmic?

## Counterfactual Explanations and Probabilistic Machine Learning

> We are working on methodologies and open-source tools to help researchers and practitioners assess the trustworthiness of predictive models. 

::::{.columns}

:::{.column width="60%"}

#### Towards Trustworthy AI in `Julia`

1. [`CounterfactualExplanations.jl`](https://github.com/pat-alt/CounterfactualExplanations.jl) (JuliaCon 2022)
2. [`ConformalPrediction.jl`](https://github.com/pat-alt/ConformalPrediction.jl) (JuliaCon 2023 --- I hope!)
3. [`LaplaceRedudx.jl`](https://github.com/pat-alt/LaplaceRedux.jl) (JuliaCon 2022)
4. [`AlgorithmicRecourseDynamics.jl`](https://github.com/pat-alt/AlgorithmicRecourseDynamics.jl)

... contributions welcome! 😊

#### More Reading

- Granular results for all of our experiments can be found in this online companion: [https://www.paltmeyer.com/endogenous-macrodynamics-in-algorithmic-recourse/](https://www.paltmeyer.com/endogenous-macrodynamics-in-algorithmic-recourse/). 
- Blog post introducing Counterfactual Explanations: [[TDS](https://towardsdatascience.com/individual-recourse-for-black-box-models-5e9ed1e4b4cc), [homepage](https://www.paltmeyer.com/blog/posts/individual-recourse-for-black-box-models/)].
- Many other related posts on my [blog](https://www.paltmeyer.com/blog).

:::

:::{.column width="40%"}

<img src="/www/images/profile.jpg" height="auto" width="250" style="border-radius:50%; display: block; margin-left: auto; margin-right: auto;">

<div style="text-align: center;">
  <p style="display: inline; vertical-align: middle"> 
    <a href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/d0fc399dee4218d1e0e0399b8947acab.png" alt="LinkedIn (Personal)" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://twitter.com/paltmey" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/3949237f892004c237021ac9e3182b1d.png" alt="Twitter" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://github.com/pat-alt" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/47f4eb2d0082a8a3611d614b75a09db8.png" alt="Github" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://medium.com/@patrick.altmeyer" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/175f49662614345cb7dbb95fce3f88af.png" alt="Medium" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
  </p>
</div>

<img src="/www/images/qr.png" height="auto" width="100" style="display: block; margin-left: auto; margin-right: auto;">
:::

::::

## Image Sources

- Copyright for stock images belongs to TU Delft.
- All other images, graphics or animations were created by us.

## References 