---
title: "[`ConformalPrediction.jl`](https://github.com/JuliaTrustworthyAI/ConformalPrediction.jl)"
subtitle: Predictive Uncertainty Quantification in Machine Learning
author: 
  - name: "Patrick Altmeyer"
    url: https://www.paltmeyer.com/
institute: Delft University of Technology
date: today
date-format: long
format: 
  julia-revealjs:
    theme: custom.scss
    self-contained: true
    smaller: false
    scrollable: true
    preview-links: auto
    slide-number: true
    transition: slide
    background-transition: fade
    fig-align: center
    html-math-method: mathjax
    include-in-header:
      - text: |
          <script>
          MathJax = {
            options: {
              menuOptions: {
                settings: {
                  assistiveMml: false
                }
              }
            }
          };
          </script>
revealjs-plugins:
  - pointer
crossref: 
  prp-title: RQ
  prp-prefix: RQ
---

## Conformal Prediction 

Conformal Prediction (CP) works under the premise of turning heuristic measures of Predictive Uncertainty (PU) into rigorous ones through repeated sampling or the use of calibration data.

![](www/intro.gif)

## Example: Split CP {.smaller}

1. Proper training set and separate calibration set: $\mathcal{D}_n=\mathcal{D}^{\text{train}} \cup \mathcal{D}^{\text{cali}}$.
2. Train model on proper training set: $\hat\mu_{i \in \mathcal{D}^{\text{train}}}(X_i,Y_i)$.
3. Compute nonconformity scores, $\mathcal{S}$, using calibration data $\mathcal{D}^{\text{cali}}$ and fitted model $\hat\mu_{i \in \mathcal{D}^{\text{train}}}$. 
4. For user-specified coverage ratio $(1-\alpha)$ compute the corresponding quantile, $\hat{q}$, of $\mathcal{S}$.
5. For the given quantile and test sample $X_{\text{test}}$, form the corresponding conformal prediction set: $C(X_{\text{test}})=\{y:s(X_{\text{test}},y) \le \hat{q}\}$.

::: {.callout-tip}
## Blog posts

- Conformal Classification ([[blog](https://www.paltmeyer.com/blog/posts/conformal-prediction/)], [[TDS](https://towardsdatascience.com/conformal-prediction-in-julia-351b81309e30)], [[Forem](https://forem.julialang.org/patalt/conformal-prediction-in-julia-h9n)])
- Conformal Regression ([[blog](https://www.paltmeyer.com/blog/posts/conformal-regression/)], [[TDS](https://towardsdatascience.com/prediction-intervals-for-any-regression-model-306930d5ad9a)], [[Forem](https://forem.julialang.org/patalt/prediction-intervals-for-any-regression-model-16f5)])
:::

# [`ConformalPrediction.jl`](https://github.com/JuliaTrustworthyAI/ConformalPrediction.jl)

::::{.columns}::::
:::{.column width='65%'}

- Fully compatible with [`MLJ.jl`](https://alan-turing-institute.github.io/MLJ.jl/dev/) models.
- Compatible with [`Flux.jl`](https://fluxml.ai/) through [`MLJFlux.jl`](https://github.com/FluxML/MLJFlux.jl).
- Many state-of-the-art CP methods implemented for regression, classification and time series modelling.

:::
:::{.column width='35%'}
![](www/wide_logo.png)

![](www/qr.svg)
:::
::::

## Talk Agenda {.smaller}

1. üèÉ Interactive sprint of [`ConformalPrediction.jl`](https://github.com/JuliaTrustworthyAI/ConformalPrediction.jl) using [`Pluto.jl`](https://github.com/fonsp/Pluto.jl) üéà (15min)
2. üîç Applications (5min)
   - Conformal Chatbot
   - Conformal Image Classifier
   - Conformal Times Series Modelling
3. üöß Under Construction (5min)
   - Differentiability and Conformal [`CounterfactualExplanations.jl`](https://github.com/JuliaTrustworthyAI/CounterfactualExplanations.jl)
   - Conformal Bayes and [`LaplaceRedux.jl`](https://github.com/JuliaTrustworthyAI/LaplaceRedux.jl)
4. ‚ùì Q&A

# üîç Applications {background-image="www/boston.png" background-position="90% 100%" background-size="50%"}

## Conformal Chatbot {.smaller}

::: {.panel-tabset}

### Overview

![High-level overview of a conformalized intent classifier.](www/llm.jpeg){#fig-llm width=75%}

::: {.callout-tip}
## Blog post

Building a Conformal Chatbot in Julia ([blog](https://www.paltmeyer.com/blog/posts/conformal-llm/), [TDS](https://medium.com/towards-data-science/building-a-conformal-chatbot-in-julia-1ed23363a280))
:::

### Demo

![Demo of a REPL-based conformalized intent classifier.](www/llm-demo.gif){#fig-llm-demo width=50%}

:::

## Conformal Image Classifier

::::{.columns}::::
:::{.column width='60%'}
MNIST classifier trained using `MLJFlux.jl`.

![](www/img-clf-res.png){width=80%}
:::
:::{.column width='40%'}
![](www/img-clf.gif){width=80%}
:::
::::

::: {.callout-tip}
## Blog post

How to Conformalize a Deep Image Classifier ([blog](https://www.paltmeyer.com/blog/posts/conformal-image-classifier/), [TDS](https://medium.com/towards-data-science/how-to-conformalize-a-deep-image-classifier-14ead4e1a5a0), [Forem](https://forem.julialang.org/patalt/how-to-conformalize-a-deep-image-classifier-50p2))
:::

## Time Series {.smaller}

::::{.columns}::::
:::{.column width='60%'}
- Ensemble Batch Prediction Intervals (EnbPI) proposed by @xu2021conformal and recently contributed by Mojtaba Farmanbar ([LinkedIn](https://www.linkedin.com/in/mfarmanbar/), [Twitter](https://twitter.com/m_farmanbar), [GitHub](https://github.com/MojiFarmanbar))
- Residuals are used sequentially as they become available to update the nonconformity scores (bottom chart of @fig-ts).
- Data source: [MAPIE](https://mapie.readthedocs.io/en/latest/index.html), @hyndman2018forecasting
:::
:::{.column width='40%'}
![EnbPI for Victoria electricity demand dataset.](www/timeseries.png){#fig-ts}
:::
::::

::: {.callout-tip}
## Tutorial

How to Conformalize a Time Series Model ([docs](https://juliatrustworthyai.github.io/ConformalPrediction.jl/stable/how_to_guides/timeseries/)) 
:::


# üöß Under Construction {background-image="www/boston.png" background-position="90% 100%" background-size="50%"}

## Differentiability {.smaller}

::: {.incremental}

- @stutz2022learning introduce a smooth set size penalty to explicitly train models for efficient CP. 
- We use this in the context of gradient-based counterfactual search to obtain plausible [`CounterfactualExplanations.jl`](https://github.com/juliatrustworthyai/CounterfactualExplanations.jl) (currently under review).

:::

. . .

![Conformal Predictions (left), set size (centre) and smooth set size loss (right).](www/diff.svg){width=85%}

::: {.callout-note}

## Contribute

Currently working on full conformal training implementation [[#62](https://github.com/JuliaTrustworthyAI/ConformalPrediction.jl/issues/62)].

:::

## Conformal Bayes {.smaller}

::::{.columns}::::
:::{.column width='50%'}

1. Conformalised Bayes: simply treat Bayesian predictive posterior as our heuristic [@angelopoulos2021gentle].
   - Recently interfaced [`LaplaceRedux.jl`](https://github.com/juliatrustworthyai/LaplaceRedux.jl) to [`MLJFlux.jl`](https://github.com/FluxML/MLJFlux.jl)
2. Conformal Bayes through importance sampling [@fong2021conformal].

:::
:::{.column width='50%'}

![](www/conformal-bayes.png)

:::
::::

::: {.callout-note}

## Contribute

Planning to add both ideas [[#64](https://github.com/JuliaTrustworthyAI/ConformalPrediction.jl/issues/64)].

:::

# üó®Ô∏è Q&A {background-image="www/boston.png" background-position="90% 100%" background-size="50%"}

## Trustworthy AI in `Julia` {.smaller}

::::{.columns}

:::{.column width="60%"}

[![](www/taija.png){width=80%   }](https://github.com/JuliaTrustworthyAI)

1. [`CounterfactualExplanations.jl`](https://github.com/juliatrustworthyai/CounterfactualExplanations.jl) (JuliaCon 2022)
2. [`ConformalPrediction.jl`](https://github.com/juliatrustworthyai/ConformalPrediction.jl) (JuliaCon 2023)
3. [`LaplaceRedudx.jl`](https://github.com/juliatrustworthyai/LaplaceRedux.jl) (JuliaCon 2022)
4. [`AlgorithmicRecourseDynamics.jl`](https://github.com/juliatrustworthyai/AlgorithmicRecourseDynamics.jl)

... contributions welcome! üòä

:::

:::{.column width="40%"}

<img src="/www/images/qr.png" height="auto" width="250" style="display: block; margin-left: auto; margin-right: auto;">

<div style="text-align: center;">
  <p style="display: inline; vertical-align: middle"> 
    <a href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/d0fc399dee4218d1e0e0399b8947acab.png" alt="LinkedIn (Personal)" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://twitter.com/paltmey" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/3949237f892004c237021ac9e3182b1d.png" alt="Twitter" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://github.com/pat-alt" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/47f4eb2d0082a8a3611d614b75a09db8.png" alt="Github" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
    <a href="https://medium.com/@patrick.altmeyer" style="display: inline-block; color: rgb(207, 142, 255) !important;">
      <font style="">
        <img width="60" height="60" src="https://s1g.s3.amazonaws.com/175f49662614345cb7dbb95fce3f88af.png" alt="Medium" style="border: none; max-width: 100%; height: 60px !important;">
      </font>
    </a>
  </p>
</div>
:::

::::

## References 