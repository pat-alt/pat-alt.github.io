<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Patrick Altmeyer">
<meta name="dcterms.date" content="2021-04-27">
<meta name="description" content="An introduction to algorithmic recourse and an implementation of a simplified version of REVISE (Joshi et al., 2019). This post was prepared as part of my PhD application.">

<title>Individual recourse for Black Box Models – patalt</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../..//www/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-abf567cae1b23626b35839fface88527.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-0e628912acf2c70b637e86adafc5dd46.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/iconify-2.1.0/iconify-icon.min.js"></script>
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BEEZ30787D"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BEEZ30787D', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Individual recourse for Black Box Models – patalt">
<meta property="og:description" content="An introduction to algorithmic recourse and an implementation of a simplified version of REVISE (Joshi et al., 2019). This post was prepared as part of my PhD application.">
<meta property="og:image" content="https://www.patalt.org/blog/posts/individual-recourse-for-black-box-models/www/intro.gif">
<meta property="og:site_name" content="patalt">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../www/icon.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">patalt</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/publications/index.html"> 
<span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/talks/index.html"> 
<span class="menu-text">Talks</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/software.html"> 
<span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../content/about/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cv" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">CV</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-cv">    
        <li>
    <a class="dropdown-item" href="../../../www/resume.pdf" target="_blank">
 <span class="dropdown-text">Compact</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../www/resume_long.pdf" target="_blank">
 <span class="dropdown-text">Detailed</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://www.taija.org/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="material-icon-theme:julia" aria-label="Icon julia from material-icon-theme Iconify.design set." title="Icon julia from material-icon-theme Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pat-alt"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/patalt.org"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="ri:bluesky-fill" aria-label="Icon bluesky-fill from ri Iconify.design set." title="Icon bluesky-fill from ri Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/"> 
<span class="menu-text"><iconify-icon role="img" inline="" icon="mdi:linkedin" aria-label="Icon linkedin from mdi Iconify.design set." title="Icon linkedin from mdi Iconify.design set."></iconify-icon></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../blog/index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#from-to" id="toc-from-to" class="nav-link active" data-scroll-target="#from-to">From 🐱 to 🐶</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  <li><a href="#annex" id="toc-annex" class="nav-link" data-scroll-target="#annex">Annex</a>
  <ul class="collapse">
  <li><a href="#linear-classifier" id="toc-linear-classifier" class="nav-link" data-scroll-target="#linear-classifier">Linear classifier</a></li>
  <li><a href="#revise-simplified" id="toc-revise-simplified" class="nav-link" data-scroll-target="#revise-simplified"><code>REVISE</code> (simplified)</a></li>
  <li><a href="#simulated-data" id="toc-simulated-data" class="nav-link" data-scroll-target="#simulated-data">Simulated data</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/pat-alt/pat-alt.github.io/blob/main/blog/posts/individual-recourse-for-black-box-models/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/pat-alt/pat-alt.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Individual recourse for Black Box Models</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Explained through a tale of 🐱’s and 🐶’s</p>
  <div class="quarto-categories">
    <div class="quarto-category">counterfactuals</div>
    <div class="quarto-category">algorithmic recourse</div>
    <div class="quarto-category">deep learning</div>
  </div>
  </div>

<div>
  <div class="description">
    An introduction to algorithmic recourse and an implementation of a simplified version of REVISE (Joshi et al., 2019). This post was prepared as part of my PhD application.
  </div>
</div>

<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://www.paltmeyer.com/">Patrick Altmeyer</a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://www.tudelft.nl/en/">
            Delft University of Technology
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 27, 2021</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="intro-gif">
<figure class="figure">
<img src="www/intro.gif" class="figure-img">
</figure>
</div>
<blockquote class="blockquote">
<p>“You cannot appeal to [algorithms]. They do not listen. Nor do they bend.”</p>
<p>— Cathy O’Neil</p>
</blockquote>
<p>In her popular book <a href="https://en.wikipedia.org/wiki/Weapons_of_Math_Destruction">Weapons of Math Destruction</a> Cathy O’Neil presents the example of public school teacher Sarah Wysocki, who lost her job after a teacher evaluation algorithm had rendered her redundant <span class="citation" data-cites="oneil2016weapons">(<a href="#ref-oneil2016weapons" role="doc-biblioref">O’Neil 2016</a>)</span>. Sarah was highly popular among her peers, supervisors and students.</p>
<p>This post looks at a novel algorithmic solution to the problem that individuals like Sarah, who are faced with an undesirable outcome, should be provided with means to revise that outcome. The literature commonly refers to this as <em>individual recourse</em>. One of the first approaches towards individual recourse was proposed by <span class="citation" data-cites="ustun2019actionable">Ustun, Spangher, and Liu (<a href="#ref-ustun2019actionable" role="doc-biblioref">2019</a>)</span>. In a recent follow-up paper, <span class="citation" data-cites="joshi2019realistic">Joshi et al. (<a href="#ref-joshi2019realistic" role="doc-biblioref">2019</a>)</span> propose a methodology coined <code>REVISE</code>, which extends the earlier approach in at least three key ways:</p>
<ol type="1">
<li><code>REVISE</code> provides a framework that avoids suggesting an unrealistic set of changes by imposing a threshold likelihood on the revised attributes.</li>
<li>It is applicable to a broader class of models including Black Box classifiers and structural causal models.</li>
<li>It can be used to detect poorly defined proxies and biases.</li>
</ol>
<p>For a detailed discussion of these points you may check out this <a href="paper_presentation.pdf">slide deck</a> or consult the paper directly (freely available on <a href="https://deepai.org/publication/towards-realistic-individual-recourse-and-actionable-explanations-in-black-box-decision-making-systems">DeepAI</a>). Here, we will abstract from some of these complications and instead look at an application of a slightly simplified version of <code>REVISE</code>. This should help us to first build a good intuition. Readers interested in the technicalities and code may find all of this in the annex below.</p>
<section id="from-to" class="level2">
<h2 class="anchored" data-anchor-id="from-to">From 🐱 to 🐶</h2>
<p>We will explain <code>REVISE</code> through a short tale of cats and dogs. The protagonist of this tale is Kitty 🐱, a young cat that identifies as a dog. Unfortunately, Kitty is not very tall and her tail, though short for a cat, is longer than that of the average dog (<a href="#fig-density" class="quarto-xref">Figure&nbsp;1</a>).</p>
<div id="fig-density" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="www/density.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Empirical distributions of simulated data set describing cats and dogs. Vertical stalks represent Kitty’s attribute values.
</figcaption>
</figure>
</div>
<p>Much to her dismay, Kitty has been recognized as a cat by a linear classifier <span class="math inline">\(g_n(X)\)</span> that we trained through stochastic gradient descent using the data on animals’ height and tail length. Once again interested readers may find technical details and code in the annex below. <a href="#fig-class" class="quarto-xref">Figure&nbsp;2</a> shows the resulting linear separation in the attribute space with the decision boundary in solid black and Kitty’s location indicated by a red circle. Can we provide individual recourse to Kitty?</p>
<div id="fig-class" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-class-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="www/class.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-class-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Linear separation of cats and dogs in the 2-dimensional attribute space with the decision boundary of the fitted classifier in solid black. Kitty’s location is indicated by a red circle.
</figcaption>
</figure>
</div>
<p>Let’s see if and how we can apply <code>REVISE</code> to Kitty’s problem. The following summary should give you some flavour of how the algorithm works:</p>
<ol type="1">
<li>Initialize <span class="math inline">\(\mathbf{x}_i'^{(0)}\)</span>, that is the attributes that will be revised recursively. Kitty’s original attributes seem like a reasonable place to start.</li>
<li>Through gradient descent recursively revise <span class="math inline">\(\mathbf{x}_i'^{(t)}\)</span> until <span class="math inline">\(g_n(\mathbf{x}_i'^{(T)})=\)</span>🐶. At this point <span class="math inline">\(T\)</span> the descent terminates since for these revised attributes the classifier labels Kitty as a dog.</li>
<li>Return <span class="math inline">\(\delta_i=\mathbf{x}_i'^{(T)}-\mathbf{x}_i\)</span>, that is the individual recourse for Kitty.</li>
</ol>
<p><a href="#fig-revise" class="quarto-xref">Figure&nbsp;3</a> illustrates what happens when this approach is applied to Kitty’s problem. The different panels show the results for different values of a regularization parameter <span class="math inline">\(\lambda\)</span> that governs the trade-off between achieving the desired label switch and keeping the distance between the original (<span class="math inline">\(\mathbf{x}_i\)</span>) and revised (<span class="math inline">\(\mathbf{x}_i'\)</span>) attributes small. In all but one case, <code>REVISE</code> converges: a decrease in tail length along with an increase in height eventually allows Kitty to cross the decision boundary. In other words, we have successfully turned Kitty into a dog - at least in the eyes of the linear classifier!</p>
<p>We also observe that as we increase <span class="math inline">\(\lambda\)</span> for a fixed learning rate, <code>REVISE</code> takes longer to converge. This should come as no surprise, since higher values of <span class="math inline">\(\lambda\)</span> lead to greater regularization with respect to the penalty we place on the distance that Kitty has to travel. When we penalize too much (<span class="math inline">\(\lambda=10\)</span>), Kitty never reaches the decision boundary, because she is reluctant to change her characteristics beyond a certain point. While not visible to the naked eye, in this particular example <span class="math inline">\(\lambda=0.001\)</span> corresponds to the best choice among the candidate values.</p>
<div id="fig-revise" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-revise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="www/revise.gif" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-revise-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The simplified <code>REVISE</code> algorithm in action: how Kitty crosses the decision boundary by changing her attributes. Regularization with respect to the distance penalty increases from top left to bottom right.
</figcaption>
</figure>
</div>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>While hopefully Kitty’s journey has provided you with some useful intuition, the story is of course very silly. Even if your cat ever seems to signal that she wants to be a dog, helping her cross that decision boundary will be tricky. Some attributes are simply immutable or very difficult to change, which <span class="citation" data-cites="joshi2019realistic">Joshi et al. (<a href="#ref-joshi2019realistic" role="doc-biblioref">2019</a>)</span> do not fail to account for in their framework. Their proposed methodology offers a simple and ingenious approach towards providing individual recourse. Instead of concerning ourselves with Black Box interpretability, why not simply provide remedy in case things go wrong?</p>
<p>To some extent that idea has its merit. As this post has hopefully shown, <code>REVISE</code> is straight-forward to understand and readily applicable. It could be a very useful tool to provide individual recourse in many real-world applications. As the implementation of our simplified version of <code>REVISE</code> demonstrates, researchers should also find it relatively easy to develop the methodology further and tailor it to specific use cases. The simpler version here, for example, may be useful in settings where the dimensionality is relatively small and one can reasonably model the distribution of attributes without the need for generative models.</p>
<p>Still, you may be wondering: if the original classifier is based on poorly defined rules and proxies, then what good does <code>REVISE</code> really do? Going back to the example of high-school teacher Sarah Wysocki, one of the key attributes determining teachers’ evaluations was their students’ performance. Realizing this, some teachers took the shortest route to success by artificially inflating their students’ test scores. That same course of action may well have been suggested by <code>REVISE</code>. As <span class="citation" data-cites="joshi2019realistic">Joshi et al. (<a href="#ref-joshi2019realistic" role="doc-biblioref">2019</a>)</span> demonstrate, this very property of <code>REVISE</code> may actually proof useful in detecting weaknesses of decision making systems before setting them loose (key contribution 3).</p>
<p>Nonetheless, the example above also demonstrates that approaches like <code>REVISE</code>, useful as they may be, tend to provide solutions for very particular problems. In reality data-driven decision making systems are often subject to many different problems and hence research on trustworthy AI will need to tackle the issue from various angles. A few places to start include the question of dealing with data that is inherently biased, improving ad-hoc and post-hoc model interpretability and continuing efforts around causality-inspired AI.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-joshi2019realistic" class="csl-entry" role="listitem">
Joshi, Shalmali, Oluwasanmi Koyejo, Warut Vijitbenjaronk, Been Kim, and Joydeep Ghosh. 2019. <span>“<span class="nocase">Towards Realistic Individual Recourse and Actionable Explanations in Black-Box Decision Making Systems</span>.”</span> <a href="https://arxiv.org/abs/1907.09615">https://arxiv.org/abs/1907.09615</a>.
</div>
<div id="ref-oneil2016weapons" class="csl-entry" role="listitem">
O’Neil, Cathy. 2016. <em>Weapons of Math Destruction: <span>How</span> Big Data Increases Inequality and Threatens Democracy</em>. <span>Crown</span>.
</div>
<div id="ref-ustun2019actionable" class="csl-entry" role="listitem">
Ustun, Berk, Alexander Spangher, and Yang Liu. 2019. <span>“Actionable Recourse in Linear Classification.”</span> In <em>Proceedings of the <span>Conference</span> on <span>Fairness</span>, <span>Accountability</span>, and <span>Transparency</span></em>, 10–19. <a href="https://doi.org/10.1145/3287560.3287566">https://doi.org/10.1145/3287560.3287566</a>.
</div>
</div>
</section>
<section id="annex" class="level2">
<h2 class="anchored" data-anchor-id="annex">Annex</h2>
<p>In my blog posts I aim to implement interesting ideas from scratch even if that sometimes means that things need to undergo some sort of simplification. The benefit of this approach is that the experience is educationally rewarding - both for myself and hopefully also for readers. The first two sections of this annex show how <code>REVISE</code> and linear classification can be implemented in R. The final section just shows how the synthetic data was generated. To also inspect the code that generates the visualizations and everything else, you can find the source code of this file on <a href="https://github.com/pat-alt/patalt/blob/master/content/post/2021-04-26-individual-recourse-for-black-box-models/index.Rmd">GitHub</a>.</p>
<section id="linear-classifier" class="level3">
<h3 class="anchored" data-anchor-id="linear-classifier">Linear classifier</h3>
<p>Linear classification is implemented through stochastic gradient descent (SGD) with Hinge loss</p>
<p><span class="math display">\[
\begin{aligned}
&amp;&amp; \ell(-\mathbf{w}^T\mathbf{x}_i y_i)&amp;=(1-\mathbf{w}^T\mathbf{x}_i y_i)_+ \\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\mathbf{w}\)</span> is a coefficient vector, <span class="math inline">\(\mathbf{x}_i\)</span> is the attribute vector of individual <span class="math inline">\(i\)</span> and <span class="math inline">\(y_i\)</span> is the individual’s outcome. Since we apply SGD in order to minimize the loss function <span class="math inline">\(\ell\)</span> by varying <span class="math inline">\(\mathbf{w}\)</span>, we need an expression for its gradient with respect to <span class="math inline">\(\mathbf{w}\)</span>, which is given by:</p>
<p><span id="eq-hinge"><span class="math display">\[
\begin{equation}
\begin{aligned}
&amp;&amp; \nabla_{\mathbf{W}} \left( \ell(-\mathbf{w}^T\mathbf{x}_i y_i) \right) &amp;= \begin{cases} -\mathbf{x}_i y_i &amp; \text{if} \ \ \ \mathbf{w}^T\mathbf{x}_i y_i \le 1\\ 0 &amp; \text{otherwise} \end{cases} \\
\end{aligned}
\end{equation}
\tag{1}\]</span></span></p>
<p>The code below uses this analytical solution to perform SGD over <span class="math inline">\(T\)</span> iterations or as long as updates yield feasible parameter values. As the final vector of coefficients the function returns <span class="math inline">\(\mathbf{\bar{w}}= \frac{1}{T} \sum_{t=1}^{T} \mathbf{w}_t\)</span>. Denoting the optimal coefficient vector as <span class="math inline">\(\mathbf{w}^*\)</span>, it can be shown that under certain conditions <span class="math inline">\(\ell(\mathbf{\bar{w}})\rightarrow\ell(\mathbf{w}^*)\)</span> as <span class="math inline">\(T\rightarrow\infty\)</span>.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">#' Stochastic gradient descent</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#'</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#' @param X Feature matrix.</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#' @param y Vector containing training labels.</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#' @param eta Learning rate.</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#' @param n_iter Maximum number of iterations.</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#' @param w_init Initial parameter values.</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#' @param save_steps Boolean checking if coefficients should be saved at each step.</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#'</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#' @return</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#' @export</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#'</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#' @author Patrick Altmeyer</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>linear_classifier <span class="ot">&lt;-</span> <span class="cf">function</span>(X,y,<span class="at">eta=</span><span class="fl">0.001</span>,<span class="at">n_iter=</span><span class="dv">1000</span>,<span class="at">w_init=</span><span class="cn">NULL</span>,<span class="at">save_steps=</span><span class="cn">FALSE</span>) {</span>
<span id="cb1-15"><a href="#cb1-15"></a>  <span class="co"># Initialization: ----</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># number of observations</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X) <span class="co"># number of dimensions</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(w_init)) {</span>
<span id="cb1-19"><a href="#cb1-19"></a>    w <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="dv">0</span>,d)) <span class="co"># initialize coefficients as zero...</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-21"><a href="#cb1-21"></a>    w <span class="ot">&lt;-</span> <span class="fu">matrix</span>(w_init) <span class="co"># ...unless initial values have been provided.</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  }</span>
<span id="cb1-23"><a href="#cb1-23"></a>  w_avg <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>n_iter <span class="sc">*</span> w <span class="co"># initialize average coefficients</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># iteration count</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>  <span class="cf">if</span> (save_steps) {</span>
<span id="cb1-26"><a href="#cb1-26"></a>    steps <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">iter=</span><span class="dv">0</span>, <span class="at">w=</span><span class="fu">c</span>(w), <span class="at">d=</span><span class="dv">1</span><span class="sc">:</span>d) <span class="co"># if desired, save coefficient at each step</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-28"><a href="#cb1-28"></a>    steps <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>  }</span>
<span id="cb1-30"><a href="#cb1-30"></a>  feasible_w <span class="ot">&lt;-</span> <span class="cn">TRUE</span> <span class="co"># to check if coefficients are finite, non-nan, ...</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>  <span class="co"># Surrogate loss:</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>  l <span class="ot">&lt;-</span> <span class="cf">function</span>(X,y,w) {</span>
<span id="cb1-33"><a href="#cb1-33"></a>    x <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="dv">1</span>) <span class="sc">*</span> <span class="fu">crossprod</span>(X,w) <span class="sc">*</span> y</span>
<span id="cb1-34"><a href="#cb1-34"></a>    <span class="fu">pmax</span>(<span class="dv">0</span>,<span class="dv">1</span> <span class="sc">+</span> x) <span class="co"># Hinge loss</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>  }</span>
<span id="cb1-36"><a href="#cb1-36"></a>  grad <span class="ot">&lt;-</span> <span class="cf">function</span>(X,y,w) {</span>
<span id="cb1-37"><a href="#cb1-37"></a>    X <span class="sc">%*%</span> <span class="fu">ifelse</span>(<span class="fu">crossprod</span>(X,w) <span class="sc">*</span> y<span class="sc">&lt;=</span><span class="dv">1</span>,<span class="sc">-</span>y,<span class="dv">0</span>) <span class="co"># Gradient of Hinge loss</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>  }</span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="co"># Stochastic gradient descent: ----</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="cf">while</span> (feasible_w <span class="sc">&amp;</span> iter<span class="sc">&lt;</span>n_iter) {</span>
<span id="cb1-41"><a href="#cb1-41"></a>    t <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n,<span class="dv">1</span>) <span class="co"># random draw</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>    X_t <span class="ot">&lt;-</span> <span class="fu">matrix</span>(X[t,])</span>
<span id="cb1-43"><a href="#cb1-43"></a>    y_t <span class="ot">&lt;-</span> <span class="fu">matrix</span>(y[t])</span>
<span id="cb1-44"><a href="#cb1-44"></a>    v_t <span class="ot">&lt;-</span> <span class="fu">grad</span>(X_t,y_t,w) <span class="co"># compute estimate of gradient</span></span>
<span id="cb1-45"><a href="#cb1-45"></a>    <span class="co"># Update:</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>    w <span class="ot">&lt;-</span> w <span class="sc">-</span> eta <span class="sc">*</span> v_t <span class="co"># update coefficient vector</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>    feasible_w <span class="ot">&lt;-</span> <span class="fu">all</span>(<span class="fu">sapply</span>(w, <span class="cf">function</span>(i) <span class="sc">!</span><span class="fu">is.na</span>(i) <span class="sc">&amp;</span> <span class="fu">is.finite</span>(i))) <span class="co"># check if feasible</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>    <span class="cf">if</span> (feasible_w) {</span>
<span id="cb1-49"><a href="#cb1-49"></a>      w_avg <span class="ot">&lt;-</span> w_avg <span class="sc">+</span> <span class="dv">1</span><span class="sc">/</span>n_iter <span class="sc">*</span> w <span class="co"># update average</span></span>
<span id="cb1-50"><a href="#cb1-50"></a>    }</span>
<span id="cb1-51"><a href="#cb1-51"></a>    <span class="cf">if</span> (save_steps) {</span>
<span id="cb1-52"><a href="#cb1-52"></a>      steps <span class="ot">&lt;-</span> <span class="fu">rbind</span>(steps, <span class="fu">data.table</span>(<span class="at">iter=</span>iter, <span class="at">w=</span><span class="fu">c</span>(w), <span class="at">d=</span><span class="dv">1</span><span class="sc">:</span>d))</span>
<span id="cb1-53"><a href="#cb1-53"></a>    }</span>
<span id="cb1-54"><a href="#cb1-54"></a>    iter <span class="ot">&lt;-</span> iter <span class="sc">+</span> <span class="dv">1</span> <span class="co"># increase counter</span></span>
<span id="cb1-55"><a href="#cb1-55"></a>  }</span>
<span id="cb1-56"><a href="#cb1-56"></a>  <span class="co"># Output: ----</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-58"><a href="#cb1-58"></a>    <span class="at">X =</span> X,</span>
<span id="cb1-59"><a href="#cb1-59"></a>    <span class="at">y =</span> <span class="fu">matrix</span>(y),</span>
<span id="cb1-60"><a href="#cb1-60"></a>    <span class="at">coefficients =</span> w_avg,</span>
<span id="cb1-61"><a href="#cb1-61"></a>    <span class="at">eta =</span> eta,</span>
<span id="cb1-62"><a href="#cb1-62"></a>    <span class="at">n_iter =</span> n_iter,</span>
<span id="cb1-63"><a href="#cb1-63"></a>    <span class="at">steps =</span> steps</span>
<span id="cb1-64"><a href="#cb1-64"></a>  )</span>
<span id="cb1-65"><a href="#cb1-65"></a>  <span class="fu">class</span>(output) <span class="ot">&lt;-</span> <span class="st">"classifier"</span> <span class="co"># assign S3 class</span></span>
<span id="cb1-66"><a href="#cb1-66"></a>  <span class="fu">return</span>(output)</span>
<span id="cb1-67"><a href="#cb1-67"></a>}</span>
<span id="cb1-68"><a href="#cb1-68"></a></span>
<span id="cb1-69"><a href="#cb1-69"></a><span class="co"># Methods: ----</span></span>
<span id="cb1-70"><a href="#cb1-70"></a>print.classifier <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier) {</span>
<span id="cb1-71"><a href="#cb1-71"></a>  <span class="fu">print</span>(<span class="st">"Coefficients:"</span>)</span>
<span id="cb1-72"><a href="#cb1-72"></a>  <span class="fu">print</span>(classifier<span class="sc">$</span>coefficients)</span>
<span id="cb1-73"><a href="#cb1-73"></a>}</span>
<span id="cb1-74"><a href="#cb1-74"></a>print <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier) {</span>
<span id="cb1-75"><a href="#cb1-75"></a>  <span class="fu">UseMethod</span>(<span class="st">"print"</span>)</span>
<span id="cb1-76"><a href="#cb1-76"></a>}</span>
<span id="cb1-77"><a href="#cb1-77"></a></span>
<span id="cb1-78"><a href="#cb1-78"></a>predict.classifier <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier, <span class="at">newdata=</span><span class="cn">NULL</span>, <span class="at">discrete=</span><span class="cn">TRUE</span>) {</span>
<span id="cb1-79"><a href="#cb1-79"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(newdata)) {</span>
<span id="cb1-80"><a href="#cb1-80"></a>    fitted <span class="ot">&lt;-</span> newdata <span class="sc">%*%</span> classifier<span class="sc">$</span>coefficients <span class="co"># out-of-sampple prediction</span></span>
<span id="cb1-81"><a href="#cb1-81"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-82"><a href="#cb1-82"></a>    fitted <span class="ot">&lt;-</span> classifier<span class="sc">$</span>X <span class="sc">%*%</span> classifier<span class="sc">$</span>coefficients <span class="co"># in-sample fit</span></span>
<span id="cb1-83"><a href="#cb1-83"></a>  }</span>
<span id="cb1-84"><a href="#cb1-84"></a>  <span class="cf">if</span> (discrete) {</span>
<span id="cb1-85"><a href="#cb1-85"></a>    fitted <span class="ot">&lt;-</span> <span class="fu">sign</span>(fitted) <span class="co"># map to {-1,1}</span></span>
<span id="cb1-86"><a href="#cb1-86"></a>  }</span>
<span id="cb1-87"><a href="#cb1-87"></a>  <span class="fu">return</span>(fitted)</span>
<span id="cb1-88"><a href="#cb1-88"></a>}</span>
<span id="cb1-89"><a href="#cb1-89"></a>predict <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier, <span class="at">newdata=</span><span class="cn">NULL</span>, <span class="at">discrete=</span><span class="cn">TRUE</span>) {</span>
<span id="cb1-90"><a href="#cb1-90"></a>  <span class="fu">UseMethod</span>(<span class="st">"predict"</span>)</span>
<span id="cb1-91"><a href="#cb1-91"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="revise-simplified" class="level3">
<h3 class="anchored" data-anchor-id="revise-simplified"><code>REVISE</code> (simplified)</h3>
<p>As flagged above, we are looking at a slightly simplified version of the algorithm presented in <span class="citation" data-cites="joshi2019realistic">Joshi et al. (<a href="#ref-joshi2019realistic" role="doc-biblioref">2019</a>)</span>. In particular, the approach here does not incorporate the threshold on the likelihood nor does it account for immutable attributes.</p>
<p>Let <span class="math inline">\(y\in\{-1,1\}\)</span> be a binary outcome variable, <span class="math inline">\(X\in\mathbb{R}^d\)</span> a feature matrix containing individuals’ attributes and <span class="math inline">\(g_n(X)\)</span> a corresponding data-dependent classifier. Suppose <span class="math inline">\(y_i=-1\)</span> (the negative outcome) for some individual characterized by attributes <span class="math inline">\(\mathbf{x}_i\)</span>. Then we want to find <span class="math inline">\(\mathbf{x}_i'\)</span> closest to <span class="math inline">\(\mathbf{x}_i\)</span> such that the classifier assigns the positive outcome <span class="math inline">\(g(\mathbf{x}_i^{'})=1\)</span>. In order to do so, we use gradient descent with Hinge loss <span class="math inline">\(\ell\)</span> to minimize the following function</p>
<p><span class="math display">\[
\begin{aligned}
&amp;&amp; \min_{\mathbf{x}_i^{'}}&amp; \ \ell(g_n(\mathbf{x}_i^{'}),1) + \lambda d(\mathbf{x}_i^{'},\mathbf{x}_i) \\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(d=||\mathbf{x}_i^{'}-\mathbf{x}_i||\)</span> denotes the Euclidean distance. Note that this time we take the coefficient vector defining <span class="math inline">\(g_n\)</span> as given and instead vary the attributes. In particular, we will perform gradient descent steps as follows</p>
<p><span class="math display">\[
\begin{aligned}
&amp;&amp; {\mathbf{x}_i^{'}}^t&amp;\leftarrow {\mathbf{x}_i^{'}}^{t-1} + \eta \nabla_{{\mathbf{x}_i^{'}}} \left( \ell(g_n(\mathbf{x}_i^{'}),1) + \lambda d(\mathbf{x}_i^{'},\mathbf{x}_i)  \right)  \\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(\eta\)</span> is the learning rate. The descent step is almost equivalent to the one described in <span class="citation" data-cites="joshi2019realistic">Joshi et al. (<a href="#ref-joshi2019realistic" role="doc-biblioref">2019</a>)</span>, but here we greatly simplify things by optimizing directly in the attribute space instead of a latent space. The gradient of the loss function looks very similar to <a href="#eq-hinge" class="quarto-xref">Equation&nbsp;1</a>. With respect to the Euclidean distance partial derivatives are of the following form:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;&amp;  \frac{\partial ||\mathbf{x}_i^{'}-\mathbf{x}_i||}{\partial {x_i'}^{(d)}}  &amp;= \frac{{x_i'}^{(d)}-{x_i}^{(d)}}{||\mathbf{x}_i^{'}-\mathbf{x}_i||} \\
\end{aligned}
\]</span></p>
<p>The code that implements this optimization follows below.</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">#' REVISE algoritm - a simplified version</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#'</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#' @param classifier The fitted classifier.</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#' @param x_star Attributes of individual seeking individual recourse.</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#' @param eta Learning rate.</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#' @param lambda Regularization parameter.</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#' @param n_iter Maximum number of operations.</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#' @param save_steps Boolean indicating if intermediate steps should be saved.</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#'</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">#' @return</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">#' @export</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#'</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">#' @author Patrick Altmeyer</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>revise.classifier <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier,x_star,<span class="at">eta=</span><span class="dv">1</span>,<span class="at">lambda=</span><span class="fl">0.01</span>,<span class="at">n_iter=</span><span class="dv">1000</span>,<span class="at">save_steps=</span><span class="cn">FALSE</span>) {</span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="co"># Initialization: ----</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  d <span class="ot">&lt;-</span> <span class="fu">length</span>(x_star) <span class="co"># number of dimensions</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">names</span>(x_star))) {</span>
<span id="cb2-18"><a href="#cb2-18"></a>    d_names <span class="ot">&lt;-</span> <span class="fu">names</span>(x_star) <span class="co"># names of attributes, if provided</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-20"><a href="#cb2-20"></a>    d_names <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"X%i"</span>, <span class="dv">1</span><span class="sc">:</span>d)</span>
<span id="cb2-21"><a href="#cb2-21"></a>  }</span>
<span id="cb2-22"><a href="#cb2-22"></a>  w <span class="ot">&lt;-</span> classifier<span class="sc">$</span>coefficients <span class="co"># coefficient vector</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>  x <span class="ot">&lt;-</span> x_star <span class="co"># initialization of revised attributes</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>  distance <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># initial distance from starting point</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>  converged <span class="ot">&lt;-</span> <span class="fu">predict</span>(classifier, <span class="at">newdata =</span> x)[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">==</span><span class="dv">1</span> <span class="co"># positive outcome?</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>  iter <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># counter</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="cf">if</span> (save_steps) {</span>
<span id="cb2-28"><a href="#cb2-28"></a>    steps <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">iter=</span><span class="dv">1</span>, <span class="at">x=</span>x, <span class="at">d=</span>d_names) <span class="co"># save intermediate steps, if desired</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-30"><a href="#cb2-30"></a>    steps <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>  }</span>
<span id="cb2-32"><a href="#cb2-32"></a>  <span class="co"># Gradients:</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>  grad <span class="ot">&lt;-</span> <span class="cf">function</span>(x,y,w) {</span>
<span id="cb2-34"><a href="#cb2-34"></a>    w <span class="sc">%*%</span> <span class="fu">ifelse</span>(<span class="fu">crossprod</span>(x,w) <span class="sc">*</span> y<span class="sc">&lt;=</span><span class="dv">1</span>,<span class="sc">-</span>y,<span class="dv">0</span>) <span class="co"># gradient of Hinge loss with respect to X</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  }</span>
<span id="cb2-36"><a href="#cb2-36"></a>  grad_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(x,x_star) {</span>
<span id="cb2-37"><a href="#cb2-37"></a>    d <span class="ot">&lt;-</span> <span class="fu">length</span>(x_star)</span>
<span id="cb2-38"><a href="#cb2-38"></a>    distance <span class="ot">&lt;-</span> <span class="fu">dist</span>(<span class="fu">matrix</span>(<span class="fu">cbind</span>(x_star,x),<span class="at">nrow=</span>d,<span class="at">byrow =</span> T))</span>
<span id="cb2-39"><a href="#cb2-39"></a>    <span class="fu">matrix</span>((x<span class="sc">-</span>x_star) <span class="sc">/</span> distance) <span class="co"># gradient of Euclidean distance with respect to X</span></span>
<span id="cb2-40"><a href="#cb2-40"></a>  }</span>
<span id="cb2-41"><a href="#cb2-41"></a>  <span class="co"># Gradient descent: ----</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>  <span class="cf">while</span>(<span class="sc">!</span>converged <span class="sc">&amp;</span> iter<span class="sc">&lt;</span>n_iter) {</span>
<span id="cb2-43"><a href="#cb2-43"></a>    <span class="cf">if</span> (distance<span class="sc">!=</span><span class="dv">0</span>) {</span>
<span id="cb2-44"><a href="#cb2-44"></a>      x <span class="ot">&lt;-</span> <span class="fu">c</span>(x <span class="sc">-</span> eta <span class="sc">*</span> (<span class="fu">grad</span>(<span class="at">x=</span><span class="fu">matrix</span>(x),<span class="at">y=</span><span class="dv">1</span>,w) <span class="sc">+</span> lambda <span class="sc">*</span> <span class="fu">grad_dist</span>(x,x_star))) <span class="co"># gradient descent step</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>    } <span class="cf">else</span> {</span>
<span id="cb2-46"><a href="#cb2-46"></a>      x <span class="ot">&lt;-</span> <span class="fu">c</span>(x <span class="sc">-</span> eta <span class="sc">*</span> <span class="fu">grad</span>(<span class="at">x=</span><span class="fu">matrix</span>(x),<span class="at">y=</span><span class="dv">1</span>,w)) <span class="co"># gradient with respect to distance not defined at zero</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>    }</span>
<span id="cb2-48"><a href="#cb2-48"></a>    converged <span class="ot">&lt;-</span> <span class="fu">predict</span>(classifier, <span class="at">newdata =</span> x)[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">==</span><span class="dv">1</span> <span class="co"># positive outcome?</span></span>
<span id="cb2-49"><a href="#cb2-49"></a>    iter <span class="ot">&lt;-</span> iter <span class="sc">+</span> <span class="dv">1</span> <span class="co"># update counter</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>    <span class="cf">if</span> (save_steps) {</span>
<span id="cb2-51"><a href="#cb2-51"></a>      steps <span class="ot">&lt;-</span> <span class="fu">rbind</span>(steps, <span class="fu">data.table</span>(<span class="at">iter=</span>iter, <span class="at">x=</span>x, <span class="at">d=</span>d_names))</span>
<span id="cb2-52"><a href="#cb2-52"></a>    }</span>
<span id="cb2-53"><a href="#cb2-53"></a>    distance <span class="ot">&lt;-</span> <span class="fu">dist</span>(<span class="fu">matrix</span>(<span class="fu">cbind</span>(x_star,x),<span class="at">nrow=</span>d,<span class="at">byrow =</span> T)) <span class="co"># update distance</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>  }</span>
<span id="cb2-55"><a href="#cb2-55"></a>  <span class="co"># Output: ----</span></span>
<span id="cb2-56"><a href="#cb2-56"></a>  <span class="cf">if</span> (converged) {</span>
<span id="cb2-57"><a href="#cb2-57"></a>    revise <span class="ot">&lt;-</span> x <span class="sc">-</span> x_star</span>
<span id="cb2-58"><a href="#cb2-58"></a>  } <span class="cf">else</span> {</span>
<span id="cb2-59"><a href="#cb2-59"></a>    revise <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb2-60"><a href="#cb2-60"></a>  }</span>
<span id="cb2-61"><a href="#cb2-61"></a>  output <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb2-62"><a href="#cb2-62"></a>    <span class="at">x_star =</span> x_star,</span>
<span id="cb2-63"><a href="#cb2-63"></a>    <span class="at">revise =</span> revise,</span>
<span id="cb2-64"><a href="#cb2-64"></a>    <span class="at">classifier =</span> classifier,</span>
<span id="cb2-65"><a href="#cb2-65"></a>    <span class="at">steps =</span> steps,</span>
<span id="cb2-66"><a href="#cb2-66"></a>    <span class="at">lambda =</span> lambda,</span>
<span id="cb2-67"><a href="#cb2-67"></a>    <span class="at">distance =</span> distance,</span>
<span id="cb2-68"><a href="#cb2-68"></a>    <span class="at">mean_distance =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(revise))</span>
<span id="cb2-69"><a href="#cb2-69"></a>  )</span>
<span id="cb2-70"><a href="#cb2-70"></a>  <span class="fu">return</span>(output)</span>
<span id="cb2-71"><a href="#cb2-71"></a>}</span>
<span id="cb2-72"><a href="#cb2-72"></a></span>
<span id="cb2-73"><a href="#cb2-73"></a>revise <span class="ot">&lt;-</span> <span class="cf">function</span>(classifier,x_star,<span class="at">eta=</span><span class="dv">1</span>,<span class="at">lambda=</span><span class="fl">0.01</span>,<span class="at">n_iter=</span><span class="dv">1000</span>,<span class="at">save_steps=</span><span class="cn">FALSE</span>) {</span>
<span id="cb2-74"><a href="#cb2-74"></a>  <span class="fu">UseMethod</span>(<span class="st">"revise"</span>)</span>
<span id="cb2-75"><a href="#cb2-75"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simulated-data" class="level3">
<h3 class="anchored" data-anchor-id="simulated-data">Simulated data</h3>
<p>The synthetic data describing cats and dogs was generated as follows:</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n=</span><span class="dv">100</span>,averages,<span class="at">noise=</span><span class="fl">0.1</span>) {</span>
<span id="cb3-2"><a href="#cb3-2"></a>  d <span class="ot">&lt;-</span> <span class="fu">ncol</span>(averages)</span>
<span id="cb3-3"><a href="#cb3-3"></a>  y <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">*</span>(<span class="fu">rbinom</span>(n,<span class="dv">1</span>,<span class="fl">0.5</span>)<span class="sc">-</span><span class="fl">0.5</span>) <span class="co"># generate binary outcome: 1=dog, -1=cat</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(averages[(y<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="dv">2</span><span class="sc">+</span><span class="dv">1</span>,]) <span class="co"># generate attributes conditional on y</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>  dogs <span class="ot">&lt;-</span> y<span class="sc">==</span><span class="dv">1</span> <span class="co"># boolean index for dogs</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  cats <span class="ot">&lt;-</span> y<span class="sc">==-</span><span class="dv">1</span> <span class="co"># boolean index for cats</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>  X[cats,] <span class="ot">&lt;-</span> X[cats,] <span class="sc">+</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fu">sum</span>(cats)<span class="sc">*</span>d),<span class="at">nrow=</span><span class="fu">sum</span>(cats)) <span class="sc">%*%</span> <span class="fu">diag</span>(noise<span class="sc">*</span>averages[<span class="dv">2</span>,]) <span class="co"># add noise for y=1 (cats)</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  X[dogs,] <span class="ot">&lt;-</span> X[dogs,] <span class="sc">+</span> </span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fu">sum</span>(dogs)<span class="sc">*</span>d),<span class="at">nrow=</span><span class="fu">sum</span>(dogs)) <span class="sc">%*%</span> <span class="fu">diag</span>(noise<span class="sc">*</span>averages[<span class="dv">2</span>,]) <span class="co"># add noise for y=1 (dogs)</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">X=</span>X,<span class="at">y=</span>y))</span>
<span id="cb3-12"><a href="#cb3-12"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{altmeyer2021,
  author = {Altmeyer, Patrick},
  title = {Individual Recourse for {Black} {Box} {Models}},
  date = {2021-04-27},
  url = {https://www.patalt.org/blog/posts/individual-recourse-for-black-box-models/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-altmeyer2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Altmeyer, Patrick. 2021. <span>“Individual Recourse for Black Box
Models.”</span> April 27, 2021. <a href="https://www.patalt.org/blog/posts/individual-recourse-for-black-box-models/">https://www.patalt.org/blog/posts/individual-recourse-for-black-box-models/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.patalt\.org\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="pat-alt/pat-alt.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb4" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">---</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="an">title:</span><span class="co"> "Individual recourse for Black Box Models"</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="an">subtitle:</span><span class="co"> "Explained through a tale of 🐱's and 🐶's"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="an">date:</span><span class="co"> "2021-04-27"</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="an">categories:</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">  - counterfactuals</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">  - algorithmic recourse</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">  - deep learning</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="an">description:</span><span class="co"> &gt;-</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="co">  An introduction to algorithmic recourse and an implementation of a simplified version of REVISE (Joshi et al., 2019). This post was prepared as part of my PhD application.</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="an">image:</span><span class="co"> www/intro.gif</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="co">---</span></span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a><span class="in">```{r setup, include=FALSE}</span></span>
<span id="cb4-15"><a href="#cb4-15"></a><span class="in">rm(list=ls())</span></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="in">knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.align='center')</span></span>
<span id="cb4-17"><a href="#cb4-17"></a><span class="in">library(reticulate)</span></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="in">library(data.table)</span></span>
<span id="cb4-19"><a href="#cb4-19"></a><span class="in">library(ggplot2)</span></span>
<span id="cb4-20"><a href="#cb4-20"></a><span class="in">library(emo)</span></span>
<span id="cb4-21"><a href="#cb4-21"></a><span class="in">library(gganimate)</span></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="in">library(ggimage)</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="in">seed &lt;- 2021</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="in">theme_set(theme_minimal())</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="in">```</span></span>
<span id="cb4-26"><a href="#cb4-26"></a></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="in">cat &lt;- data.table(x=c(3,0,2,5),y=c(5,3,0,2),type="Cat",state=1:4)</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="in">dog &lt;- data.table(y=c(3,0,2,5),x=c(5,3,0,2),type="Dog",state=1:4)</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="in">dt_toy &lt;- rbind(cat,dog)</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="in">dt_toy[,emoji:=sprintf("blog/posts/individual-recourse-for-black-box-models/www/%s.png",tolower(type))]</span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="in">p &lt;- ggplot(data=dt_toy, aes(x=x,y=y,image=emoji)) +</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="in">  geom_image(size=0.2) +</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="in">  transition_states(</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="in">    state,</span></span>
<span id="cb4-36"><a href="#cb4-36"></a><span class="in">    transition_length = 2,</span></span>
<span id="cb4-37"><a href="#cb4-37"></a><span class="in">    state_length = 1</span></span>
<span id="cb4-38"><a href="#cb4-38"></a><span class="in">  ) +</span></span>
<span id="cb4-39"><a href="#cb4-39"></a><span class="in">  theme_void() +</span></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="in">  theme(</span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="in">    panel.border = element_rect(colour = "black", fill=NA, size=3)</span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="in">  ) </span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="in">animate(p, width = 300, height = 300)</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="in">anim_save("blog/posts/individual-recourse-for-black-box-models/www/toy.gif")</span></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="in">```</span></span>
<span id="cb4-46"><a href="#cb4-46"></a></span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a>&lt;div class="intro-gif"&gt;</span>
<span id="cb4-49"><a href="#cb4-49"></a>  &lt;figure&gt;</span>
<span id="cb4-50"><a href="#cb4-50"></a>    &lt;img src="www/intro.gif"&gt;</span>
<span id="cb4-51"><a href="#cb4-51"></a>  &lt;/figure&gt;</span>
<span id="cb4-52"><a href="#cb4-52"></a>&lt;/div&gt;</span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a><span class="at">&gt; "You cannot appeal to </span><span class="co">[</span><span class="ot">algorithms</span><span class="co">]</span><span class="at">. They do not listen. Nor do they bend."</span></span>
<span id="cb4-55"><a href="#cb4-55"></a><span class="at">&gt;</span></span>
<span id="cb4-56"><a href="#cb4-56"></a><span class="at">&gt; --- Cathy O'Neil</span></span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a>In her popular book <span class="co">[</span><span class="ot">Weapons of Math Destruction</span><span class="co">](https://en.wikipedia.org/wiki/Weapons_of_Math_Destruction)</span> Cathy O'Neil presents the example of public school teacher Sarah Wysocki, who lost her job after a teacher evaluation algorithm had rendered her redundant <span class="co">[</span><span class="ot">@oneil2016weapons</span><span class="co">]</span>. Sarah was highly popular among her peers, supervisors and students. </span>
<span id="cb4-59"><a href="#cb4-59"></a></span>
<span id="cb4-60"><a href="#cb4-60"></a>This post looks at a novel algorithmic solution to the problem that individuals like Sarah, who are faced with an undesirable outcome, should be provided with means to revise that outcome. The literature commonly refers to this as *individual recourse*. One of the first approaches towards individual recourse was proposed by @ustun2019actionable.  In a recent follow-up paper, @joshi2019realistic propose a methodology coined <span class="in">`REVISE`</span>, which extends the earlier approach in at least three key ways:</span>
<span id="cb4-61"><a href="#cb4-61"></a></span>
<span id="cb4-62"><a href="#cb4-62"></a><span class="ss">1. </span><span class="in">`REVISE`</span> provides a framework that avoids suggesting an unrealistic set of changes by imposing a threshold likelihood on the revised attributes.</span>
<span id="cb4-63"><a href="#cb4-63"></a><span class="ss">2. </span>It is applicable to a broader class of models including Black Box classifiers and structural causal models.</span>
<span id="cb4-64"><a href="#cb4-64"></a><span class="ss">3. </span>It can be used to detect poorly defined proxies and biases.</span>
<span id="cb4-65"><a href="#cb4-65"></a></span>
<span id="cb4-66"><a href="#cb4-66"></a>For a detailed discussion of these points you may check out this <span class="co">[</span><span class="ot">slide deck</span><span class="co">](paper_presentation.pdf)</span> or consult the paper directly (freely available on <span class="co">[</span><span class="ot">DeepAI</span><span class="co">](https://deepai.org/publication/towards-realistic-individual-recourse-and-actionable-explanations-in-black-box-decision-making-systems)</span>). Here, we will abstract from some of these complications and instead look at an application of a slightly simplified version of <span class="in">`REVISE`</span>. This should help us to first build a good intuition. Readers interested in the technicalities and code may find all of this in the annex below. </span>
<span id="cb4-67"><a href="#cb4-67"></a></span>
<span id="cb4-68"><a href="#cb4-68"></a><span class="fu">## From `r emo::ji("cat")` to `r emo::ji("dog")`</span></span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a><span class="in">```{r sim-data, echo=FALSE}</span></span>
<span id="cb4-71"><a href="#cb4-71"></a><span class="in">sim_data &lt;- function(n=100,averages,noise=0.1) {</span></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="in">  d &lt;- ncol(averages)</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="in">  y &lt;- 2*(rbinom(n,1,0.5)-0.5) # generate binary outcome: 1=dog, -1=cat</span></span>
<span id="cb4-74"><a href="#cb4-74"></a><span class="in">  X &lt;- as.matrix(averages[(y+1)/2+1,]) # generate attributes conditional on y</span></span>
<span id="cb4-75"><a href="#cb4-75"></a><span class="in">  dogs &lt;- y==1</span></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="in">  cats &lt;- y==-1</span></span>
<span id="cb4-77"><a href="#cb4-77"></a><span class="in">  X[cats,] &lt;- X[cats,] + </span></span>
<span id="cb4-78"><a href="#cb4-78"></a><span class="in">    matrix(rnorm(sum(cats)*d),nrow=sum(cats)) %*% diag(noise*averages[2,]) # add noise for y=1 (cats)</span></span>
<span id="cb4-79"><a href="#cb4-79"></a><span class="in">  X[dogs,] &lt;- X[dogs,] + </span></span>
<span id="cb4-80"><a href="#cb4-80"></a><span class="in">    matrix(rnorm(sum(dogs)*d),nrow=sum(dogs)) %*% diag(noise*averages[2,]) # add noise for y=1 (dogs)</span></span>
<span id="cb4-81"><a href="#cb4-81"></a><span class="in">  return(list(X=X,y=y))</span></span>
<span id="cb4-82"><a href="#cb4-82"></a><span class="in">}</span></span>
<span id="cb4-83"><a href="#cb4-83"></a><span class="in">set.seed(seed)</span></span>
<span id="cb4-84"><a href="#cb4-84"></a><span class="in">n &lt;- 1000</span></span>
<span id="cb4-85"><a href="#cb4-85"></a><span class="in">averages = data.table(height=c(50,100),tail=c(50,20))</span></span>
<span id="cb4-86"><a href="#cb4-86"></a><span class="in">invisible(list2env(sim_data(n=n,averages = averages),envir = environment()))</span></span>
<span id="cb4-87"><a href="#cb4-87"></a><span class="in">```</span></span>
<span id="cb4-88"><a href="#cb4-88"></a></span>
<span id="cb4-89"><a href="#cb4-89"></a>We will explain <span class="in">`REVISE`</span> through a short tale of cats and dogs. The protagonist of this tale is Kitty <span class="in">`r emo::ji("cat")`</span>, a young cat that identifies as a dog. Unfortunately, Kitty is not very tall and her tail, though short for a cat, is longer than that of the average dog (@fig-density).</span>
<span id="cb4-90"><a href="#cb4-90"></a></span>
<span id="cb4-93"><a href="#cb4-93"></a><span class="in">```{r}</span></span>
<span id="cb4-94"><a href="#cb4-94"></a><span class="fu">set.seed</span>(seed) <span class="co"># reproducibility</span></span>
<span id="cb4-95"><a href="#cb4-95"></a>poor_cats <span class="ot">&lt;-</span> X[y<span class="sc">==-</span><span class="dv">1</span>,] <span class="co"># all those poor cats</span></span>
<span id="cb4-96"><a href="#cb4-96"></a>kitty <span class="ot">&lt;-</span> poor_cats[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(poor_cats),<span class="dv">1</span>),] <span class="co"># poor kitty</span></span>
<span id="cb4-97"><a href="#cb4-97"></a>kitty_dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">value=</span>kitty,<span class="at">variable=</span>stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">names</span>(kitty)))</span>
<span id="cb4-98"><a href="#cb4-98"></a>kitty_dt_w <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">height=</span>kitty[<span class="st">"height"</span>], <span class="at">tail=</span>kitty[<span class="st">"tail"</span>])</span>
<span id="cb4-99"><a href="#cb4-99"></a><span class="in">```</span></span>
<span id="cb4-100"><a href="#cb4-100"></a></span>
<span id="cb4-103"><a href="#cb4-103"></a><span class="in">```{r}</span></span>
<span id="cb4-104"><a href="#cb4-104"></a><span class="co">#| label: fig-density</span></span>
<span id="cb4-105"><a href="#cb4-105"></a><span class="co">#| fig-cap: Empirical distributions of simulated data set describing cats and dogs. Vertical stalks represent Kitty's attribute values.</span></span>
<span id="cb4-106"><a href="#cb4-106"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(y,X)</span>
<span id="cb4-107"><a href="#cb4-107"></a>dt <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt, <span class="at">id.vars =</span> <span class="st">"y"</span>)</span>
<span id="cb4-108"><a href="#cb4-108"></a>dt[,y<span class="sc">:</span><span class="er">=</span><span class="fu">as.factor</span>(y)]</span>
<span id="cb4-109"><a href="#cb4-109"></a><span class="fu">levels</span>(dt<span class="sc">$</span>y) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Cat"</span>, <span class="st">"Dog"</span>)</span>
<span id="cb4-110"><a href="#cb4-110"></a>dt_plot <span class="ot">&lt;-</span> <span class="fu">copy</span>(dt)</span>
<span id="cb4-111"><a href="#cb4-111"></a><span class="fu">levels</span>(dt_plot<span class="sc">$</span>variable) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Height"</span>, <span class="st">"Tail"</span>)</span>
<span id="cb4-112"><a href="#cb4-112"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data=</span>dt_plot, <span class="fu">aes</span>(<span class="at">x=</span>value)) <span class="sc">+</span></span>
<span id="cb4-113"><a href="#cb4-113"></a>  <span class="fu">geom_density</span>(<span class="at">alpha=</span><span class="fl">0.25</span>, <span class="fu">aes</span>(<span class="at">fill=</span><span class="fu">factor</span>(y))) <span class="sc">+</span></span>
<span id="cb4-114"><a href="#cb4-114"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable,<span class="at">scales=</span><span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb4-115"><a href="#cb4-115"></a>  <span class="fu">scale_fill_manual</span>(<span class="st">"Outcome:"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"orange"</span>,<span class="st">"brown"</span>)) <span class="sc">+</span></span>
<span id="cb4-116"><a href="#cb4-116"></a>  <span class="fu">geom_vline</span>(<span class="at">data=</span>kitty_dt, <span class="fu">aes</span>(<span class="at">xintercept=</span>value), <span class="at">colour=</span><span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb4-117"><a href="#cb4-117"></a>  <span class="fu">geom_image</span>(<span class="at">data=</span>kitty_dt, <span class="fu">aes</span>(<span class="at">x=</span>value, <span class="at">y=</span><span class="fu">c</span>(<span class="fl">0.05</span>,<span class="fl">0.20</span>)), <span class="at">image=</span><span class="st">"blog/posts/individual-recourse-for-black-box-models/www/cat.png"</span>, <span class="at">size=</span><span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb4-118"><a href="#cb4-118"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-119"><a href="#cb4-119"></a>    <span class="at">x=</span><span class="cn">NULL</span>,</span>
<span id="cb4-120"><a href="#cb4-120"></a>    <span class="at">y=</span><span class="st">"Conditional density"</span></span>
<span id="cb4-121"><a href="#cb4-121"></a>  )</span>
<span id="cb4-122"><a href="#cb4-122"></a>p</span>
<span id="cb4-123"><a href="#cb4-123"></a><span class="in">```</span></span>
<span id="cb4-124"><a href="#cb4-124"></a></span>
<span id="cb4-125"><a href="#cb4-125"></a><span class="al">![Empirical distributions of simulated data set describing cats and dogs. Vertical stalks represent Kitty's attribute values.](www/density.png)</span>{#fig-density}</span>
<span id="cb4-126"><a href="#cb4-126"></a></span>
<span id="cb4-127"><a href="#cb4-127"></a>Much to her dismay, Kitty has been recognized as a cat by a linear classifier $g_n(X)$ that we trained through stochastic gradient descent using the data on animals' height and tail length. Once again interested readers may find technical details and code in the annex below. @fig-class shows the resulting linear separation in the attribute space with the decision boundary in solid black and Kitty's location indicated by a red circle. Can we provide individual recourse to Kitty?</span>
<span id="cb4-128"><a href="#cb4-128"></a></span>
<span id="cb4-129"><a href="#cb4-129"></a><span class="in">```{r fit}</span></span>
<span id="cb4-130"><a href="#cb4-130"></a><span class="in">source("blog/posts/individual-recourse-for-black-box-models/R/linear_classifier.R")</span></span>
<span id="cb4-131"><a href="#cb4-131"></a><span class="in">n_iter &lt;- 1000 </span></span>
<span id="cb4-132"><a href="#cb4-132"></a><span class="in">mod &lt;- linear_classifier(X,y,save_steps = T, n_iter = n_iter) # fit classifier</span></span>
<span id="cb4-133"><a href="#cb4-133"></a><span class="in">y_hat &lt;- predict(mod) # predict labels</span></span>
<span id="cb4-134"><a href="#cb4-134"></a><span class="in">```</span></span>
<span id="cb4-135"><a href="#cb4-135"></a></span>
<span id="cb4-138"><a href="#cb4-138"></a><span class="in">```{r}</span></span>
<span id="cb4-139"><a href="#cb4-139"></a><span class="co">#| label: fig-class</span></span>
<span id="cb4-140"><a href="#cb4-140"></a><span class="co">#| fig-cap: Linear separation of cats and dogs in the 2-dimensional attribute space with the decision boundary of the fitted classifier in solid black. Kitty's location is indicated by a red circle.</span></span>
<span id="cb4-141"><a href="#cb4-141"></a>dt_plot <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">y_hat =</span> <span class="fu">factor</span>(y_hat), X)</span>
<span id="cb4-142"><a href="#cb4-142"></a><span class="fu">levels</span>(dt_plot<span class="sc">$</span>y_hat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Cat"</span>, <span class="st">"Dog"</span>)</span>
<span id="cb4-143"><a href="#cb4-143"></a>dt_plot[,alpha<span class="sc">:</span><span class="er">=</span><span class="dv">1</span>]</span>
<span id="cb4-144"><a href="#cb4-144"></a>dt_plot[,emoji<span class="sc">:</span><span class="er">=</span><span class="fu">sprintf</span>(<span class="st">"blog/posts/individual-recourse-for-black-box-models/www/%s.png"</span>,<span class="fu">tolower</span>(y_hat))]</span>
<span id="cb4-145"><a href="#cb4-145"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-146"><a href="#cb4-146"></a>  <span class="fu">geom_image</span>(<span class="at">data=</span>dt_plot,<span class="fu">aes</span>(<span class="at">x=</span>height,<span class="at">y=</span>tail,<span class="at">image=</span>emoji)) <span class="sc">+</span></span>
<span id="cb4-147"><a href="#cb4-147"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope=</span><span class="sc">-</span>mod<span class="sc">$</span>coefficients[<span class="dv">1</span>,]<span class="sc">/</span>mod<span class="sc">$</span>coefficients[<span class="dv">2</span>,]) <span class="sc">+</span></span>
<span id="cb4-148"><a href="#cb4-148"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-149"><a href="#cb4-149"></a>    <span class="at">x=</span><span class="st">"Height"</span>,</span>
<span id="cb4-150"><a href="#cb4-150"></a>    <span class="at">y=</span><span class="st">"Tail"</span></span>
<span id="cb4-151"><a href="#cb4-151"></a>  )</span>
<span id="cb4-152"><a href="#cb4-152"></a>p <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data=</span>kitty_dt_w,<span class="fu">aes</span>(<span class="at">x=</span>height,<span class="at">y=</span>tail),<span class="at">colour=</span><span class="st">"coral"</span>, <span class="at">shape=</span><span class="dv">1</span>, <span class="at">stroke=</span><span class="dv">2</span>, <span class="at">size=</span><span class="dv">7</span>)</span>
<span id="cb4-153"><a href="#cb4-153"></a><span class="in">```</span></span>
<span id="cb4-154"><a href="#cb4-154"></a></span>
<span id="cb4-155"><a href="#cb4-155"></a><span class="al">![Linear separation of cats and dogs in the 2-dimensional attribute space with the decision boundary of the fitted classifier in solid black. Kitty's location is indicated by a red circle.](www/class.png)</span>{#fig-class}</span>
<span id="cb4-156"><a href="#cb4-156"></a></span>
<span id="cb4-159"><a href="#cb4-159"></a><span class="in">```{r}</span></span>
<span id="cb4-160"><a href="#cb4-160"></a><span class="fu">set.seed</span>(seed)</span>
<span id="cb4-161"><a href="#cb4-161"></a><span class="fu">source</span>(<span class="st">"blog/posts/individual-recourse-for-black-box-models/R/revise.R"</span>)</span>
<span id="cb4-162"><a href="#cb4-162"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-163"><a href="#cb4-163"></a>  <span class="fl">0.00001</span>,<span class="fl">0.001</span>,<span class="fl">0.1</span>,<span class="dv">10</span></span>
<span id="cb4-164"><a href="#cb4-164"></a>)</span>
<span id="cb4-165"><a href="#cb4-165"></a>recourse_for_cat <span class="ot">&lt;-</span> <span class="fu">lapply</span>(</span>
<span id="cb4-166"><a href="#cb4-166"></a>  <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(lambda),</span>
<span id="cb4-167"><a href="#cb4-167"></a>  <span class="cf">function</span>(i) {</span>
<span id="cb4-168"><a href="#cb4-168"></a>    <span class="fu">revise</span>(mod, kitty, <span class="at">save_steps =</span> <span class="cn">TRUE</span>, <span class="at">lambda=</span>lambda[i], <span class="at">n_iter =</span> n_iter)</span>
<span id="cb4-169"><a href="#cb4-169"></a>  }</span>
<span id="cb4-170"><a href="#cb4-170"></a>)</span>
<span id="cb4-171"><a href="#cb4-171"></a><span class="in">```</span></span>
<span id="cb4-172"><a href="#cb4-172"></a></span>
<span id="cb4-175"><a href="#cb4-175"></a><span class="in">```{r}</span></span>
<span id="cb4-176"><a href="#cb4-176"></a>steps <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(</span>
<span id="cb4-177"><a href="#cb4-177"></a>  <span class="fu">lapply</span>(</span>
<span id="cb4-178"><a href="#cb4-178"></a>    recourse_for_cat,</span>
<span id="cb4-179"><a href="#cb4-179"></a>    <span class="cf">function</span>(i) {</span>
<span id="cb4-180"><a href="#cb4-180"></a>      steps <span class="ot">&lt;-</span> <span class="fu">dcast</span>(i<span class="sc">$</span>steps, iter <span class="sc">~</span> d, <span class="at">value.var =</span> <span class="st">"x"</span>)</span>
<span id="cb4-181"><a href="#cb4-181"></a>      steps[,lambda<span class="sc">:</span><span class="er">=</span>i<span class="sc">$</span>lambda]</span>
<span id="cb4-182"><a href="#cb4-182"></a>      steps[,distance<span class="sc">:</span><span class="er">=</span>i<span class="sc">$</span>distance]</span>
<span id="cb4-183"><a href="#cb4-183"></a>    }</span>
<span id="cb4-184"><a href="#cb4-184"></a>  )</span>
<span id="cb4-185"><a href="#cb4-185"></a>)</span>
<span id="cb4-186"><a href="#cb4-186"></a>steps[,y_hat<span class="sc">:</span><span class="er">=</span><span class="fu">factor</span>(<span class="fu">predict</span>(mod, <span class="at">newdata =</span> <span class="fu">cbind</span>(height,tail)))]</span>
<span id="cb4-187"><a href="#cb4-187"></a>steps[,alpha<span class="sc">:</span><span class="er">=</span><span class="dv">2</span>]</span>
<span id="cb4-188"><a href="#cb4-188"></a>states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">100</span>,<span class="dv">120</span>,<span class="dv">200</span>,<span class="dv">500</span>,<span class="dv">1000</span>)</span>
<span id="cb4-189"><a href="#cb4-189"></a>states_merged <span class="ot">&lt;-</span> steps[</span>
<span id="cb4-190"><a href="#cb4-190"></a>  ,</span>
<span id="cb4-191"><a href="#cb4-191"></a>  <span class="fu">lapply</span>(states, <span class="cf">function</span>(i) {<span class="fu">ifelse</span>(<span class="fu">max</span>(iter)<span class="sc">&lt;=</span>i,<span class="fu">max</span>(iter),i)}),</span>
<span id="cb4-192"><a href="#cb4-192"></a>  by<span class="ot">=</span>lambda</span>
<span id="cb4-193"><a href="#cb4-193"></a>]</span>
<span id="cb4-194"><a href="#cb4-194"></a>steps <span class="ot">&lt;-</span> <span class="fu">merge</span>(steps,states_merged,<span class="at">by=</span><span class="st">"lambda"</span>)</span>
<span id="cb4-195"><a href="#cb4-195"></a>steps <span class="ot">&lt;-</span> <span class="fu">melt</span>(steps, <span class="at">measure.vars =</span> <span class="fu">sprintf</span>(<span class="st">"V%i"</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(states)))</span>
<span id="cb4-196"><a href="#cb4-196"></a>steps <span class="ot">&lt;-</span> steps[iter<span class="sc">==</span>value]</span>
<span id="cb4-197"><a href="#cb4-197"></a><span class="fu">levels</span>(steps<span class="sc">$</span>variable) <span class="ot">&lt;-</span> states</span>
<span id="cb4-198"><a href="#cb4-198"></a><span class="fu">levels</span>(steps<span class="sc">$</span>y_hat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Cat"</span>, <span class="st">"Dog"</span>)</span>
<span id="cb4-199"><a href="#cb4-199"></a><span class="in">```</span></span>
<span id="cb4-200"><a href="#cb4-200"></a></span>
<span id="cb4-201"><a href="#cb4-201"></a><span class="in">```{r, eval=FALSE}</span></span>
<span id="cb4-202"><a href="#cb4-202"></a><span class="in">steps[,emoji:=sprintf("blog/posts/individual-recourse-for-black-box-models/www/%s.png",tolower(y_hat))]</span></span>
<span id="cb4-203"><a href="#cb4-203"></a><span class="in">p &lt;- p +</span></span>
<span id="cb4-204"><a href="#cb4-204"></a><span class="in">  geom_image(data=steps,aes(x=height,y=tail,image=emoji), size=0.1) +</span></span>
<span id="cb4-205"><a href="#cb4-205"></a><span class="in">  facet_wrap(~lambda) +</span></span>
<span id="cb4-206"><a href="#cb4-206"></a><span class="in">  transition_states(</span></span>
<span id="cb4-207"><a href="#cb4-207"></a><span class="in">    variable,</span></span>
<span id="cb4-208"><a href="#cb4-208"></a><span class="in">    transition_length = 2,</span></span>
<span id="cb4-209"><a href="#cb4-209"></a><span class="in">    state_length = 1</span></span>
<span id="cb4-210"><a href="#cb4-210"></a><span class="in">  ) +</span></span>
<span id="cb4-211"><a href="#cb4-211"></a><span class="in">  labs(</span></span>
<span id="cb4-212"><a href="#cb4-212"></a><span class="in">    title="Iteration: {closest_state}"</span></span>
<span id="cb4-213"><a href="#cb4-213"></a><span class="in">  ) </span></span>
<span id="cb4-214"><a href="#cb4-214"></a><span class="in">animate(p, width = 600, height = 600)</span></span>
<span id="cb4-215"><a href="#cb4-215"></a><span class="in">anim_save("blog/posts/individual-recourse-for-black-box-models/www/revise.gif")</span></span>
<span id="cb4-216"><a href="#cb4-216"></a><span class="in">```</span></span>
<span id="cb4-217"><a href="#cb4-217"></a></span>
<span id="cb4-218"><a href="#cb4-218"></a>Let's see if and how we can apply <span class="in">`REVISE`</span> to Kitty's problem. The following summary should give you some flavour of how the algorithm works:</span>
<span id="cb4-219"><a href="#cb4-219"></a></span>
<span id="cb4-220"><a href="#cb4-220"></a><span class="ss">1. </span>Initialize $\mathbf{x}_i'^{(0)}$, that is the attributes that will be revised recursively. Kitty's original attributes seem like a reasonable place to start.</span>
<span id="cb4-221"><a href="#cb4-221"></a><span class="ss">2. </span>Through gradient descent recursively revise $\mathbf{x}_i'^{(t)}$ until $g_n(\mathbf{x}_i'^{(T)})=$<span class="in">`r emo::ji("dog")`</span>. At this point $T$ the descent terminates since for these revised attributes the classifier labels Kitty as a dog.</span>
<span id="cb4-222"><a href="#cb4-222"></a><span class="ss">3. </span>Return $\delta_i=\mathbf{x}_i'^{(T)}-\mathbf{x}_i$, that is the individual recourse for Kitty.</span>
<span id="cb4-223"><a href="#cb4-223"></a></span>
<span id="cb4-224"><a href="#cb4-224"></a>@fig-revise illustrates what happens when this approach is applied to Kitty's problem. The different panels show the results for different values of a regularization parameter $\lambda$ that governs the trade-off between achieving the desired label switch and keeping the distance between the original ($\mathbf{x}_i$) and revised ($\mathbf{x}_i'$) attributes small. In all but one case, <span class="in">`REVISE`</span> converges: a decrease in tail length along with an increase in height eventually allows Kitty to cross the decision boundary. In other words, we have successfully turned Kitty into a dog - at least in the eyes of the linear classifier!</span>
<span id="cb4-225"><a href="#cb4-225"></a></span>
<span id="cb4-226"><a href="#cb4-226"></a>We also observe that as we increase $\lambda$ for a fixed learning rate, <span class="in">`REVISE`</span> takes longer to converge. This should come as no surprise, since higher values of $\lambda$ lead to greater regularization with respect to the penalty we place on the distance that Kitty has to travel. When we penalize too much ($\lambda=10$), Kitty never reaches the decision boundary, because she is reluctant to change her characteristics beyond a certain point. While not visible to the naked eye, in this particular example $\lambda=0.001$ corresponds to the best choice among the candidate values.</span>
<span id="cb4-227"><a href="#cb4-227"></a></span>
<span id="cb4-228"><a href="#cb4-228"></a><span class="al">![The simplified `REVISE` algorithm in action: how Kitty crosses the decision boundary by changing her attributes. Regularization with respect to the distance penalty increases from top left to bottom right.](www/revise.gif)</span>{#fig-revise}</span>
<span id="cb4-229"><a href="#cb4-229"></a></span>
<span id="cb4-230"><a href="#cb4-230"></a><span class="in">```{r, eval=F}</span></span>
<span id="cb4-231"><a href="#cb4-231"></a><span class="in">dt_dist &lt;- steps[,.(distance=unique(distance)),by=lambda]</span></span>
<span id="cb4-232"><a href="#cb4-232"></a><span class="in">kableExtra::kable(dt_dist, col.names = c("$\\lambda$","Euclidean distance"))</span></span>
<span id="cb4-233"><a href="#cb4-233"></a><span class="in">```</span></span>
<span id="cb4-234"><a href="#cb4-234"></a></span>
<span id="cb4-235"><a href="#cb4-235"></a><span class="fu">## Discussion</span></span>
<span id="cb4-236"><a href="#cb4-236"></a></span>
<span id="cb4-237"><a href="#cb4-237"></a>While hopefully Kitty’s journey has provided you with some useful intuition, the story is of course very silly. Even if your cat ever seems to signal that she wants to be a dog, helping her cross that decision boundary will be tricky. Some attributes are simply immutable or very difficult to change, which @joshi2019realistic do not fail to account for in their framework. Their proposed methodology offers a simple and ingenious approach towards providing individual recourse. Instead of concerning ourselves with Black Box interpretability, why not simply provide remedy in case things go wrong?</span>
<span id="cb4-238"><a href="#cb4-238"></a></span>
<span id="cb4-239"><a href="#cb4-239"></a>To some extent that idea has its merit. As this post has hopefully shown, <span class="in">`REVISE`</span> is straight-forward to understand and readily applicable. It could be a very useful tool to provide individual recourse in many real-world applications. As the implementation of our simplified version of <span class="in">`REVISE`</span> demonstrates, researchers should also find it relatively easy to develop the methodology further and tailor it to specific use cases. The simpler version here, for example, may be useful in settings where the dimensionality is relatively small and one can reasonably model the distribution of attributes without the need for generative models.</span>
<span id="cb4-240"><a href="#cb4-240"></a></span>
<span id="cb4-241"><a href="#cb4-241"></a>Still, you may be wondering: if the original classifier is based on poorly defined rules and proxies, then what good does <span class="in">`REVISE`</span> really do? Going back to the example of high-school teacher Sarah Wysocki, one of the key attributes determining teachers' evaluations was their students' performance. Realizing this, some teachers took the shortest route to success by artificially inflating their students' test scores. That same course of action may well have been suggested by <span class="in">`REVISE`</span>. As @joshi2019realistic demonstrate, this very property of <span class="in">`REVISE`</span> may actually proof useful in detecting weaknesses of decision making systems before setting them loose (key contribution 3).</span>
<span id="cb4-242"><a href="#cb4-242"></a></span>
<span id="cb4-243"><a href="#cb4-243"></a>Nonetheless, the example above also demonstrates that approaches like <span class="in">`REVISE`</span>, useful as they may be, tend to provide solutions for very particular problems. In reality data-driven decision making systems are often subject to many different problems and hence research on trustworthy AI will need to tackle the issue from various angles. A few places to start include the question of dealing with data that is inherently biased, improving ad-hoc and post-hoc model interpretability and continuing efforts around causality-inspired AI.</span>
<span id="cb4-244"><a href="#cb4-244"></a></span>
<span id="cb4-245"><a href="#cb4-245"></a><span class="fu">## References</span></span>
<span id="cb4-246"><a href="#cb4-246"></a></span>
<span id="cb4-247"><a href="#cb4-247"></a>&lt;div id="refs"&gt;&lt;/div&gt;</span>
<span id="cb4-248"><a href="#cb4-248"></a></span>
<span id="cb4-249"><a href="#cb4-249"></a><span class="fu">## Annex </span></span>
<span id="cb4-250"><a href="#cb4-250"></a></span>
<span id="cb4-251"><a href="#cb4-251"></a>In my blog posts I aim to implement interesting ideas from scratch even if that sometimes means that things need to undergo some sort of simplification. The benefit of this approach is that the experience is educationally rewarding - both for myself and hopefully also for readers. The first two sections of this annex show how <span class="in">`REVISE`</span> and linear classification can be implemented in R. The final section just shows how the synthetic data was generated. To also inspect the code that generates the visualizations and everything else, you can find the source code of this file on <span class="co">[</span><span class="ot">GitHub</span><span class="co">](https://github.com/pat-alt/patalt/blob/master/content/post/2021-04-26-individual-recourse-for-black-box-models/index.Rmd)</span>.</span>
<span id="cb4-252"><a href="#cb4-252"></a></span>
<span id="cb4-253"><a href="#cb4-253"></a><span class="fu">### Linear classifier</span></span>
<span id="cb4-254"><a href="#cb4-254"></a></span>
<span id="cb4-255"><a href="#cb4-255"></a>Linear classification is implemented through stochastic gradient descent (SGD) with Hinge loss</span>
<span id="cb4-256"><a href="#cb4-256"></a></span>
<span id="cb4-257"><a href="#cb4-257"></a>$$</span>
<span id="cb4-258"><a href="#cb4-258"></a>\begin{aligned}</span>
<span id="cb4-259"><a href="#cb4-259"></a>&amp;&amp; \ell(-\mathbf{w}^T\mathbf{x}_i y_i)&amp;=(1-\mathbf{w}^T\mathbf{x}_i y_i)_+ <span class="sc">\\</span></span>
<span id="cb4-260"><a href="#cb4-260"></a>\end{aligned}</span>
<span id="cb4-261"><a href="#cb4-261"></a>$$</span>
<span id="cb4-262"><a href="#cb4-262"></a></span>
<span id="cb4-263"><a href="#cb4-263"></a>where $\mathbf{w}$ is a coefficient vector, $\mathbf{x}_i$ is the attribute vector of individual $i$ and $y_i$ is the individual's outcome. Since we apply SGD in order to minimize the loss function $\ell$ by varying $\mathbf{w}$, we need an expression for its gradient with respect to $\mathbf{w}$, which is given by:</span>
<span id="cb4-264"><a href="#cb4-264"></a></span>
<span id="cb4-265"><a href="#cb4-265"></a>$$</span>
<span id="cb4-266"><a href="#cb4-266"></a>\begin{equation} </span>
<span id="cb4-267"><a href="#cb4-267"></a>\begin{aligned}</span>
<span id="cb4-268"><a href="#cb4-268"></a>&amp;&amp; \nabla_{\mathbf{W}} \left( \ell(-\mathbf{w}^T\mathbf{x}_i y_i) \right) &amp;= \begin{cases} -\mathbf{x}_i y_i &amp; \text{if} \ \ \ \mathbf{w}^T\mathbf{x}_i y_i \le 1<span class="sc">\\</span> 0 &amp; \text{otherwise} \end{cases} <span class="sc">\\</span></span>
<span id="cb4-269"><a href="#cb4-269"></a>\end{aligned}</span>
<span id="cb4-270"><a href="#cb4-270"></a>\end{equation}</span>
<span id="cb4-271"><a href="#cb4-271"></a>$$ {#eq-hinge}</span>
<span id="cb4-272"><a href="#cb4-272"></a></span>
<span id="cb4-273"><a href="#cb4-273"></a>The code below uses this analytical solution to perform SGD over $T$ iterations or as long as updates yield feasible parameter values. As the final vector of coefficients the function returns $\mathbf{\bar{w}}= \frac{1}{T} \sum_{t=1}^{T} \mathbf{w}_t$. Denoting the optimal coefficient vector as $\mathbf{w}^*$, it can be shown that under certain conditions $\ell(\mathbf{\bar{w}})\rightarrow\ell(\mathbf{w}^*)$ as $T\rightarrow\infty$.</span>
<span id="cb4-274"><a href="#cb4-274"></a></span>
<span id="cb4-275"><a href="#cb4-275"></a><span class="in">```{r, code=readLines("R/linear_classifier.R"), eval=FALSE, echo=TRUE}</span></span>
<span id="cb4-276"><a href="#cb4-276"></a><span class="in">```</span></span>
<span id="cb4-277"><a href="#cb4-277"></a></span>
<span id="cb4-278"><a href="#cb4-278"></a><span class="fu">### `REVISE` (simplified)</span></span>
<span id="cb4-279"><a href="#cb4-279"></a></span>
<span id="cb4-280"><a href="#cb4-280"></a>As flagged above, we are looking at a slightly simplified version of the algorithm presented in @joshi2019realistic. In particular, the approach here does not incorporate the threshold on the likelihood nor does it account for immutable attributes.</span>
<span id="cb4-281"><a href="#cb4-281"></a></span>
<span id="cb4-282"><a href="#cb4-282"></a>Let $y\in<span class="sc">\{</span>-1,1<span class="sc">\}</span>$ be a binary outcome variable, $X\in\mathbb{R}^d$ a feature matrix containing individuals' attributes and $g_n(X)$ a corresponding data-dependent classifier. Suppose $y_i=-1$ (the negative outcome) for some individual characterized by attributes $\mathbf{x}_i$. Then we want to find $\mathbf{x}_i'$ closest to $\mathbf{x}_i$ such that the classifier assigns the positive outcome $g(\mathbf{x}_i^{'})=1$. In order to do so, we use gradient descent with Hinge loss $\ell$ to minimize the following function </span>
<span id="cb4-283"><a href="#cb4-283"></a></span>
<span id="cb4-284"><a href="#cb4-284"></a>$$</span>
<span id="cb4-285"><a href="#cb4-285"></a>\begin{aligned}</span>
<span id="cb4-286"><a href="#cb4-286"></a>&amp;&amp; \min_{\mathbf{x}_i^{'}}&amp; \ \ell(g_n(\mathbf{x}_i^{'}),1) + \lambda d(\mathbf{x}_i^{'},\mathbf{x}_i) <span class="sc">\\</span></span>
<span id="cb4-287"><a href="#cb4-287"></a>\end{aligned}</span>
<span id="cb4-288"><a href="#cb4-288"></a>$$</span>
<span id="cb4-289"><a href="#cb4-289"></a></span>
<span id="cb4-290"><a href="#cb4-290"></a>where $d=||\mathbf{x}_i^{'}-\mathbf{x}_i||$ denotes the Euclidean distance. Note that this time we take the coefficient vector defining $g_n$ as given and instead vary the attributes. In particular, we will perform gradient descent steps as follows</span>
<span id="cb4-291"><a href="#cb4-291"></a></span>
<span id="cb4-292"><a href="#cb4-292"></a>$$</span>
<span id="cb4-293"><a href="#cb4-293"></a>\begin{aligned}</span>
<span id="cb4-294"><a href="#cb4-294"></a>&amp;&amp; {\mathbf{x}_i^{'}}^t&amp;\leftarrow {\mathbf{x}_i^{'}}^{t-1} + \eta \nabla_{{\mathbf{x}_i^{'}}} \left( \ell(g_n(\mathbf{x}_i^{'}),1) + \lambda d(\mathbf{x}_i^{'},\mathbf{x}_i)  \right)  <span class="sc">\\</span></span>
<span id="cb4-295"><a href="#cb4-295"></a>\end{aligned}</span>
<span id="cb4-296"><a href="#cb4-296"></a>$$</span>
<span id="cb4-297"><a href="#cb4-297"></a></span>
<span id="cb4-298"><a href="#cb4-298"></a>where $\eta$ is the learning rate. The descent step is almost equivalent to the one described in @joshi2019realistic, but here we greatly simplify things by optimizing directly in the attribute space instead of a latent space. The gradient of the loss function looks very similar to @eq-hinge. With respect to the Euclidean distance partial derivatives are of the following form:</span>
<span id="cb4-299"><a href="#cb4-299"></a></span>
<span id="cb4-300"><a href="#cb4-300"></a>$$</span>
<span id="cb4-301"><a href="#cb4-301"></a>\begin{aligned}</span>
<span id="cb4-302"><a href="#cb4-302"></a>&amp;&amp;  \frac{\partial ||\mathbf{x}_i^{'}-\mathbf{x}_i||}{\partial {x_i'}^{(d)}}  &amp;= \frac{{x_i'}^{(d)}-{x_i}^{(d)}}{||\mathbf{x}_i^{'}-\mathbf{x}_i||} <span class="sc">\\</span></span>
<span id="cb4-303"><a href="#cb4-303"></a>\end{aligned}</span>
<span id="cb4-304"><a href="#cb4-304"></a>$$</span>
<span id="cb4-305"><a href="#cb4-305"></a></span>
<span id="cb4-306"><a href="#cb4-306"></a>The code that implements this optimization follows below.</span>
<span id="cb4-307"><a href="#cb4-307"></a></span>
<span id="cb4-308"><a href="#cb4-308"></a><span class="in">```{r, code=readLines("R/revise.R"), eval=FALSE, echo=TRUE}</span></span>
<span id="cb4-309"><a href="#cb4-309"></a><span class="in">```</span></span>
<span id="cb4-310"><a href="#cb4-310"></a></span>
<span id="cb4-311"><a href="#cb4-311"></a><span class="fu">### Simulated data</span></span>
<span id="cb4-312"><a href="#cb4-312"></a></span>
<span id="cb4-313"><a href="#cb4-313"></a>The synthetic data describing cats and dogs was generated as follows:</span>
<span id="cb4-314"><a href="#cb4-314"></a></span>
<span id="cb4-315"><a href="#cb4-315"></a><span class="in">```{r, eval=FALSE, echo=TRUE}</span></span>
<span id="cb4-316"><a href="#cb4-316"></a><span class="in">sim_data &lt;- function(n=100,averages,noise=0.1) {</span></span>
<span id="cb4-317"><a href="#cb4-317"></a><span class="in">  d &lt;- ncol(averages)</span></span>
<span id="cb4-318"><a href="#cb4-318"></a><span class="in">  y &lt;- 2*(rbinom(n,1,0.5)-0.5) # generate binary outcome: 1=dog, -1=cat</span></span>
<span id="cb4-319"><a href="#cb4-319"></a><span class="in">  X &lt;- as.matrix(averages[(y+1)/2+1,]) # generate attributes conditional on y</span></span>
<span id="cb4-320"><a href="#cb4-320"></a><span class="in">  dogs &lt;- y==1 # boolean index for dogs</span></span>
<span id="cb4-321"><a href="#cb4-321"></a><span class="in">  cats &lt;- y==-1 # boolean index for cats</span></span>
<span id="cb4-322"><a href="#cb4-322"></a><span class="in">  X[cats,] &lt;- X[cats,] + </span></span>
<span id="cb4-323"><a href="#cb4-323"></a><span class="in">    matrix(rnorm(sum(cats)*d),nrow=sum(cats)) %*% diag(noise*averages[2,]) # add noise for y=1 (cats)</span></span>
<span id="cb4-324"><a href="#cb4-324"></a><span class="in">  X[dogs,] &lt;- X[dogs,] + </span></span>
<span id="cb4-325"><a href="#cb4-325"></a><span class="in">    matrix(rnorm(sum(dogs)*d),nrow=sum(dogs)) %*% diag(noise*averages[2,]) # add noise for y=1 (dogs)</span></span>
<span id="cb4-326"><a href="#cb4-326"></a><span class="in">  return(list(X=X,y=y))</span></span>
<span id="cb4-327"><a href="#cb4-327"></a><span class="in">}</span></span>
<span id="cb4-328"><a href="#cb4-328"></a><span class="in">```</span></span>
<span id="cb4-329"><a href="#cb4-329"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" class="img-fluid" alt="License: MIT"></a> <a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg" class="img-fluid" alt="CC BY 4.0"></a> © 2025, Patrick Altmeyer</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/pat-alt/pat-alt.github.io/blob/main/blog/posts/individual-recourse-for-black-box-models/index.qmd" class="toc-action"><i class="bi bi-github"></i>View source</a></li><li><a href="https://github.com/pat-alt/pat-alt.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.patalt.org/">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://www.taija.org/">
<p><iconify-icon role="img" inline="" icon="material-icon-theme:julia" aria-label="Icon julia from material-icon-theme Iconify.design set." title="Icon julia from material-icon-theme Iconify.design set."></iconify-icon></p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pat-alt">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/patalt.org">
<p><iconify-icon role="img" inline="" icon="ri:bluesky-fill" aria-label="Icon bluesky-fill from ri Iconify.design set." title="Icon bluesky-fill from ri Iconify.design set."></iconify-icon></p>
</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/patrick-altmeyer-a2a25494/">
<p><iconify-icon role="img" inline="" icon="mdi:linkedin" aria-label="Icon linkedin from mdi Iconify.design set." title="Icon linkedin from mdi Iconify.design set."></iconify-icon></p>
</a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://medium.com/@patrick.altmeyer">
      <i class="bi bi-medium" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>